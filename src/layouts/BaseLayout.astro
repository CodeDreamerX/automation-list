---
import "../styles/globals.css";
import { supabase } from "../lib/supabaseClient";

interface Props {
  title?: string;
  description?: string;
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string;
  ogUrl?: string;
  ogType?: string;
  lang?: string;
  navItems?: Array<{ label: string; href: string }>;
  canonical?: string;
  meta?: {
    canonical?: string;
  };
}

const {
  title = "Automation List",
  description = "Discover the best automation tools and workflows for your productivity needs.",
  ogTitle,
  ogDescription = description,
  ogImage,
  ogUrl,
  ogType = "website",
  lang = "en",
  navItems: navItemsProp,
  canonical,
  meta,
} = Astro.props;

// Determine canonical URL: use meta.canonical if provided, otherwise use canonical prop, otherwise generate from Astro.url.href
const canonicalUrl = meta?.canonical || canonical || Astro.url.href;

// Generate hreflang URLs
const currentPath = Astro.url.pathname;
const origin = Astro.url.origin;

// Generate English and German alternate URLs
let enUrl: string;
let deUrl: string;

if (currentPath.startsWith("/de/")) {
  // Currently on German page
  enUrl = origin + currentPath.replace(/^\/de/, "/en");
  deUrl = origin + currentPath;
} else if (currentPath.startsWith("/en/")) {
  // Currently on English page
  enUrl = origin + currentPath;
  deUrl = origin + currentPath.replace(/^\/en/, "/de");
} else {
  // Fallback for root or other paths
  enUrl = origin + "/en" + currentPath;
  deUrl = origin + "/de" + currentPath;
}

// x-default points to English version
const xDefaultUrl = enUrl;

// Determine OG locale based on language
const ogLocale = lang === "de" ? "de_DE" : "en_US";

// Determine OG image with fallback
const ogImageUrl = ogImage || `${origin}/og/default.png`;

// Fetch active categories from database for footer links
const { data: dbCategories } = await supabase
  .from("categories")
  .select("id, slug, name_en, name_de")
  .eq("is_active", true)
  .order("order_index", { ascending: true, nullsLast: true })
  .order("name_en", { ascending: true });

// Fetch vendors to get top countries by vendor count
const { data: vendors } = await supabase
  .from("vendors")
  .select("country")
  .not("country", "is", null);

// Count vendors by country
const countryCounts: Record<string, number> = {};
(vendors || []).forEach((vendor: any) => {
  if (vendor.country && typeof vendor.country === "string") {
    const country = vendor.country.trim();
    if (country.length > 0) {
      countryCounts[country] = (countryCounts[country] || 0) + 1;
    }
  }
});

// Get top 8 countries by vendor count
const popularCountries = Object.entries(countryCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 8)
  .map(([country]) => country);

// Helper function to convert country name to URL slug (matching country page format)
function countryToSlug(country: string): string {
  return encodeURIComponent(country.toLowerCase().trim());
}

const navItems = navItemsProp || [
  { label: "Home", href: "/en/" },
  { label: "Categories", href: "/en/categories" },
  { label: "Vendors", href: "/en/vendors" },
  { label: "Blog", href: "/en/blog" },
  { label: "Contact", href: "/en/contact" },
];

// Language switching logic
const isGerman = currentPath.startsWith("/de/");
const isEnglish = currentPath.startsWith("/en/");

// Determine the target language and URL
let languageToggleUrl: string;
let languageToggleLabel: string;

if (isGerman) {
  // Currently on German page, switch to English
  // Replace /de/ with /en/
  languageToggleUrl = currentPath.replace(/^\/de/, "/en") || "/en/";
  languageToggleLabel = "EN";
} else if (isEnglish) {
  // Currently on English page, switch to German
  // Replace /en/ with /de/
  languageToggleUrl = currentPath.replace(/^\/en/, "/de") || "/de/";
  languageToggleLabel = "DE";
} else {
  // Fallback for root pages or other paths
  // Default to switching to German
  languageToggleUrl = "/de/";
  languageToggleLabel = "DE";
}
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="de" href={deUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={ogTitle || title} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:site_name" content="Automation List" />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:image" content={ogImageUrl} />
    {ogUrl && <meta property="og:url" content={ogUrl} />}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content={ogTitle || title} />
    <meta property="twitter:description" content={ogDescription} />
    <meta property="twitter:image" content={ogImageUrl} />

    <!-- MailerLite Universal -->
    <script is:inline>
      (function (w, d, e, u, f, l, n) {
        w[f] =
          w[f] ||
          function () {
            (w[f].q = w[f].q || []).push(arguments);
          };
        l = d.createElement(e);
        l.async = 1;
        l.src = u;
        n = d.getElementsByTagName(e)[0];
        n.parentNode.insertBefore(l, n);
      })(window, document, "script", "https://assets.mailerlite.com/js/universal.js", "ml");
      window.ml && window.ml("account", "1905335");
    </script>
    <!-- End MailerLite Universal -->
    <slot name="head" />
  </head>
  <body>
    <!-- HEADER -->
    <header class="sticky top-0 z-50 backdrop-blur-md bg-white/80 border-b border-orange-500 shadow-sm">
      <nav class="container-px mx-auto max-w-7xl">
        <div class="flex items-center justify-between h-12">
          <!-- LOGO -->
          <div class="flex-shrink-0">
            <a href={isGerman ? "/de/" : isEnglish ? "/en/" : "/en/"} class="text-lg font-bold text-gray-900 hover:text-brand-600 transition-colors">
              Automation List
            </a>
          </div>

          <!-- NAV LINKS -->
          <div class="hidden md:flex items-center space-x-1">
            {navItems.map((item) => (
              <a
                href={item.href}
                class="text-sm font-medium text-gray-900 px-2.5 py-1 rounded-md hover:bg-brand-50 transition-colors"
                class:list={[
                  Astro.url.pathname === item.href && "bg-brand-100 text-brand-600"
                ]}
              >
                {item.label}
              </a>
            ))}
          </div>

          <!-- DE TOGGLE & MOBILE MENU -->
          <div class="flex items-center space-x-3">
            <a
              href={languageToggleUrl}
              class="text-sm font-medium text-gray-700 border border-gray-300 px-2.5 py-1 rounded-md hover:bg-gray-50 transition-colors"
              aria-label={`Switch to ${languageToggleLabel === "DE" ? "German" : "English"}`}
            >
              {languageToggleLabel}
            </a>

            <!-- MOBILE MENU BUTTON -->
            <button
              type="button"
              class="md:hidden p-1.5 rounded-md text-gray-700 hover:bg-gray-100 transition-colors"
              aria-label="Toggle menu"
              id="mobile-menu-toggle"
            >
              Menu
            </button>
          </div>
        </div>

        <!-- MOBILE MENU -->
        <div
          id="mobile-menu"
          class="hidden md:hidden border-t border-orange-500 py-3"
        >
          <div class="flex flex-col space-y-2">
            {navItems.map((item) => (
              <a
                href={item.href}
                class="text-sm font-medium text-gray-700 hover:text-brand-600 transition-colors px-3 py-1.5 rounded-md hover:bg-gray-50"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>
      </nav>
    </header>

    <!-- MAIN CONTENT -->
    <main>
      <slot />
    </main>

    <!-- FOOTER -->
    <footer class="bg-[#F9FAFB] border-t border-gray-200 mt-auto">
      <div class="container-px mx-auto max-w-7xl px-4 py-12 md:py-16">
        <!-- 3-Column Layout -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12 mb-8">
          <!-- Column 1: Brand -->
          <div class="flex flex-col space-y-4">
            <h3 class="text-lg font-bold text-gray-900">Automation List</h3>
            <p class="text-sm text-[#6B7280]">
              {isGerman 
                ? "Entdecken Sie die besten Automatisierungstools und Workflows für Ihre Produktivitätsbedürfnisse."
                : "Discover the best automation tools and workflows for your productivity needs."}
            </p>
            <a 
              href={isGerman ? "/de/contact" : "/en/contact"}
              class="text-sm text-[#6B7280] hover:underline w-fit"
            >
              {isGerman ? "Über uns" : "About"}
            </a>
          </div>

          <!-- Column 2: Explore -->
          <div class="flex flex-col space-y-4">
            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide">
              {isGerman ? "Erkunden" : "Explore"}
            </h4>
            <nav class="flex flex-col space-y-2">
              <a 
                href={isGerman ? "/de/vendors" : "/en/vendors"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Anbieter" : "Vendors"}
              </a>
              <a 
                href={isGerman ? "/de/categories" : "/en/categories"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Kategorien" : "Categories"}
              </a>
              <a 
                href={isGerman ? "/de/blog" : "/en/blog"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Blog" : "Blog"}
              </a>
            </nav>
          </div>

          <!-- Column 3: Popular Countries -->
          <div class="flex flex-col space-y-4">
            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide">
              {isGerman ? "Beliebte Länder" : "Popular Countries"}
            </h4>
            <nav class="flex flex-col space-y-2">
              {popularCountries.length > 0 ? (
                popularCountries.map((country) => {
                  const countrySlug = countryToSlug(country);
                  return (
                    <a
                      href={isGerman ? `/de/country/${countrySlug}` : `/en/country/${countrySlug}`}
                      class="text-sm text-[#6B7280] hover:underline"
                    >
                      {country}
                    </a>
                  );
                })
              ) : (
                <span class="text-sm text-[#6B7280]">
                  {isGerman ? "Keine Länder verfügbar" : "No countries available"}
                </span>
              )}
            </nav>
          </div>
        </div>

        <!-- Divider -->
        <div class="border-t border-gray-200 pt-8">
          <!-- Copyright -->
          <div class="text-center text-sm text-[#6B7280] space-y-1">
            <p>© 2025 Automation List. All rights reserved.</p>
            <p>Made in Switzerland.</p>
          </div>
        </div>
      </div>
    </footer>

    <!-- MOBILE MENU SCRIPT -->
    <script>
      const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");

      mobileMenuToggle?.addEventListener("click", () => {
        mobileMenu?.classList.toggle("hidden");
      });
    </script>
  </body>
</html>

