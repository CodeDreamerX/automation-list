---
import "../styles/globals.css";
import { supabase } from "../lib/supabaseClient";
import CookieBanner from "../components/CookieBanner.astro";
import Breadcrumb from "../components/Breadcrumb.astro";

interface BaseLayoutProps {
  title?: string;
  description?: string | null;
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string;
  ogUrl?: string;
  ogType?: string;
  lang?: string;
  navItems?: Array<{ label: string; href: string }>;
  breadcrumbs?: Array<{ label: string; href: string }>;
  canonical?: string;
  meta?: {
    canonical?: string;
  };
}

const {
  title = "Automation List",
  description: descriptionProp,
  ogTitle,
  ogDescription: ogDescriptionProp,
  ogImage,
  ogUrl,
  ogType = "website",
  lang = "en",
  navItems: navItemsProp,
  breadcrumbs,
  canonical,
  meta,
} = Astro.props;

// Handle empty strings: treat them as missing and use fallback
// For vendor pages: only render meta description if explicitly provided (not null)
// If descriptionProp is null, don't render meta tag (description = undefined)
// If descriptionProp is undefined (not provided), use fallback
const description = descriptionProp === null 
  ? undefined 
  : (descriptionProp && descriptionProp.trim()) || "Discover the best automation tools and workflows for your productivity needs.";
const ogDescription = (ogDescriptionProp && ogDescriptionProp.trim()) || description;

// Normalize origin to always use https and www for consistency
// This ensures canonical, hreflang, and OG URLs all use the same domain format
const normalizeOrigin = (urlOrigin: string): string => {
  // Ensure https protocol
  let normalized = urlOrigin.replace(/^http:/, 'https:');
  // Ensure www subdomain (unless already has www)
  // Note: For production domains, always use www. For localhost, preserve whatever format is used
  if (!normalized.includes('www.')) {
    // For localhost, check if the original had www, otherwise keep as is
    // For production domains (automation-list.com), always add www
    if (!normalized.includes('localhost')) {
      normalized = normalized.replace(/^(https?:\/\/)(.+)$/, '$1www.$2');
    }
  }
  return normalized;
};

// Determine canonical URL: use meta.canonical if provided, otherwise use canonical prop, otherwise generate from normalized origin
const canonicalUrl = meta?.canonical || canonical || (normalizeOrigin(Astro.url.origin) + Astro.url.pathname + Astro.url.search);

// Extract origin from canonical URL if provided, otherwise normalize Astro.url.origin
// This ensures hreflang URLs match the canonical URL's domain format
let origin: string;
if (canonicalUrl && (meta?.canonical || canonical)) {
  // Extract origin from the canonical URL and normalize it
  try {
    const canonicalUrlObj = new URL(canonicalUrl);
    origin = normalizeOrigin(canonicalUrlObj.origin);
  } catch {
    // Fallback to normalized origin if URL parsing fails
    origin = normalizeOrigin(Astro.url.origin);
  }
} else {
  // Use normalized origin
  origin = normalizeOrigin(Astro.url.origin);
}

// Generate hreflang URLs
const currentPath = Astro.url.pathname;

// Generate English and German alternate URLs
let enUrl: string;
let deUrl: string;

if (currentPath.startsWith("/de/")) {
  // Currently on German page
  enUrl = origin + currentPath.replace(/^\/de/, "/en");
  deUrl = origin + currentPath;
} else if (currentPath.startsWith("/en/")) {
  // Currently on English page
  enUrl = origin + currentPath;
  deUrl = origin + currentPath.replace(/^\/en/, "/de");
} else {
  // Fallback for root or other paths
  enUrl = origin + "/en" + currentPath;
  deUrl = origin + "/de" + currentPath;
}

// x-default points to English version
const xDefaultUrl = enUrl;

// Determine OG locale based on language
const ogLocale = lang === "de" ? "de_DE" : "en_US";

// Determine OG image with fallback
const ogImageUrl = ogImage || `${origin}/og/default.png`;

// Fetch active categories from database for footer links
const { data: dbCategories } = await supabase
  .from("categories")
  .select("id, slug, name_en, name_de")
  .eq("is_active", true)
  .order("order_index", { ascending: true, nullsFirst: false })
  .order("name_en", { ascending: true });

  // Fetch vendor counts by country from materialized view
  const { data: countryVendorCounts } = await supabase
    .from("country_vendor_counts")
    .select("country, vendor_count")
    .order("vendor_count", { ascending: false })
    .limit(8);

// Get top 8 countries by vendor count from materialized view
const popularCountries = (countryVendorCounts || [])
  .filter((item: any) => item.country && typeof item.country === "string" && item.country.trim().length > 0)
  .map((item: any) => item.country.trim());

// Country name translations (English -> German)
const countryTranslations: Record<string, string> = {
  'switzerland': 'Schweiz',
  'germany': 'Deutschland',
  'austria': 'Österreich',
  'france': 'Frankreich',
  'italy': 'Italien',
  'united states': 'Vereinigte Staaten',
  'united kingdom': 'Vereinigtes Königreich',
  'netherlands': 'Niederlande',
  'belgium': 'Belgien',
  'spain': 'Spanien',
  'portugal': 'Portugal',
  'poland': 'Polen',
  'czech republic': 'Tschechien',
  'czechia': 'Tschechien',
  'denmark': 'Dänemark',
  'sweden': 'Schweden',
  'norway': 'Norwegen',
  'finland': 'Finnland',
  'hungary': 'Ungarn',
  'romania': 'Rumänien',
  'slovakia': 'Slowakei',
  'slovenia': 'Slowenien',
  'croatia': 'Kroatien',
  'serbia': 'Serbien',
  'greece': 'Griechenland',
  'turkey': 'Türkei',
  'japan': 'Japan',
  'china': 'China',
  'south korea': 'Südkorea',
  'india': 'Indien',
  'brazil': 'Brasilien',
  'mexico': 'Mexiko',
  'canada': 'Kanada',
  'australia': 'Australien',
  'south africa': 'Südafrika',
  'russia': 'Russland',
  'ukraine': 'Ukraine',
  'israel': 'Israel',
  'singapore': 'Singapur',
  'taiwan': 'Taiwan',
  'thailand': 'Thailand',
  'indonesia': 'Indonesien',
  'malaysia': 'Malaysia',
  'philippines': 'Philippinen',
  'vietnam': 'Vietnam',
  'new zealand': 'Neuseeland',
  'argentina': 'Argentinien',
  'chile': 'Chile',
  'colombia': 'Kolumbien',
  'peru': 'Peru',
  'venezuela': 'Venezuela',
};

// Helper function to translate country name based on language
function translateCountryName(country: string, targetLang: string): string {
  if (targetLang === 'de') {
    const countryLower = country.toLowerCase().trim();
    return countryTranslations[countryLower] || country;
  }
  return country;
}

// Helper function to convert country name to URL slug (matching country page format)
// Uses hyphens to match the format expected by country pages (which convert hyphens back to spaces)
function countryToSlug(country: string): string {
  return country
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-'); // Replace spaces with hyphens
}

// Language switching logic - use both path detection and lang prop for reliability
const isGerman = lang === "de" || currentPath.startsWith("/de/");
const isEnglish = lang === "en" || currentPath.startsWith("/en/");

// Generate navItems based on language if not provided
const navItems = navItemsProp || (isGerman ? [
  { label: "Kategorien", href: "/de/categories" },
  { label: "Anbieter", href: "/de/vendors" },
  { label: "Technologien", href: "/de/technologies" },
  { label: "Branchen", href: "/de/industries" },
  { label: "Kontakt", href: "/de/contact" },
] : [
  { label: "Categories", href: "/en/categories" },
  { label: "Vendors", href: "/en/vendors" },
  { label: "Technologies", href: "/en/technologies" },
  { label: "Industries", href: "/en/industries" },
  { label: "Contact", href: "/en/contact" },
]);

// Determine the target language and URL
let languageToggleUrl: string;
let languageToggleLabel: string;

if (isGerman) {
  // Currently on German page, switch to English
  // Replace /de/ with /en/
  languageToggleUrl = currentPath.replace(/^\/de/, "/en") || "/en/";
  languageToggleLabel = "EN";
} else if (isEnglish) {
  // Currently on English page, switch to German
  // Replace /en/ with /de/
  languageToggleUrl = currentPath.replace(/^\/en/, "/de") || "/de/";
  languageToggleLabel = "DE";
} else {
  // Fallback for root pages or other paths
  // Default to switching to German
  languageToggleUrl = "/de/";
  languageToggleLabel = "DE";
}
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    {description && <meta name="description" content={description} />}
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="de" href={deUrl} />
    <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={ogTitle || title} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:site_name" content="Automation List" />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:image" content={ogImageUrl} />
    {ogUrl && <meta property="og:url" content={ogUrl} />}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content={ogTitle || title} />
    <meta property="twitter:description" content={ogDescription} />
    <meta property="twitter:image" content={ogImageUrl} />

    <!-- Cookie Consent - Client-side only GA loading -->
    <!-- NO GA LOADED DURING SSR - Only loads after explicit consent -->
    <script is:inline>
      // Client-side only: Check consent and load GA if already accepted
      // This runs AFTER page load, ensuring zero SSR GA execution
      (function() {
        if (typeof window === "undefined") return;
        
        function loadGoogleAnalytics() {
          // Double-check consent before loading
          try {
            const consent = localStorage.getItem("cookie_consent");
            if (consent !== "accepted") {
              return; // No consent, do nothing
            }
          } catch (e) {
            return; // localStorage unavailable, do nothing
          }
          
          // Prevent double-loading
          if (document.querySelector('script[src*="googletagmanager.com/gtag/js"]')) {
            return;
          }
          
          const GA_MEASUREMENT_ID = "G-ERFBQMBSJP";
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            window.dataLayer.push(arguments);
          }
          
          const script = document.createElement("script");
          script.async = true;
          script.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_MEASUREMENT_ID;
          document.head.appendChild(script);
          
          gtag("js", new Date());
          gtag("config", GA_MEASUREMENT_ID, { anonymize_ip: true });
          window.gtag = gtag;
        }
        
        // Wait for DOM to be ready, then check consent
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", loadGoogleAnalytics);
        } else {
          // DOM already ready, use setTimeout to ensure client-side execution
          setTimeout(loadGoogleAnalytics, 0);
        }
      })();
    </script>

    <slot name="head" />
  </head>
  <body>
    <!-- HEADER -->
    <header class="sticky top-0 z-50 backdrop-blur-md bg-white/80 border-b border-orange-500 shadow-sm">
      <nav class="container-px mx-auto max-w-7xl">
        <div class="flex items-center justify-between h-12">
          <!-- LOGO -->
          <div class="flex-shrink-0">
            <a href={isGerman ? "/de/" : isEnglish ? "/en/" : "/en/"} class="text-lg font-bold text-gray-900 hover:text-brand-600 transition-colors">
              Automation List
            </a>
          </div>

          <!-- NAV LINKS -->
          <div class="hidden md:flex items-center space-x-1">
            {navItems.map((item: { label: string; href: string }) => (
              <a
                href={item.href}
                class="text-sm font-medium text-gray-900 px-2.5 py-1 rounded-md hover:bg-brand-50 transition-colors"
                class:list={[
                  Astro.url.pathname === item.href && "bg-brand-100 text-brand-600"
                ]}
              >
                {item.label}
              </a>
            ))}
          </div>

          <!-- DE TOGGLE & MOBILE MENU -->
          <div class="flex items-center space-x-3">
            <a
              href={languageToggleUrl}
              class="text-sm font-medium text-gray-700 border border-gray-300 px-2.5 py-1 rounded-md hover:bg-gray-50 transition-colors"
              aria-label={`Switch to ${languageToggleLabel === "DE" ? "German" : "English"}`}
            >
              {languageToggleLabel}
            </a>

            <!-- MOBILE MENU BUTTON -->
            <button
              type="button"
              class="md:hidden p-1.5 rounded-md text-gray-700 hover:bg-gray-100 transition-colors"
              aria-label="Toggle menu"
              id="mobile-menu-toggle"
            >
              Menu
            </button>
          </div>
        </div>

        <!-- MOBILE MENU -->
        <div
          id="mobile-menu"
          class="hidden md:hidden border-t border-orange-500 py-3"
        >
          <div class="flex flex-col space-y-2">
            {navItems.map((item: { label: string; href: string }) => (
              <a
                href={item.href}
                class="text-sm font-medium text-gray-700 hover:text-brand-600 transition-colors px-3 py-1.5 rounded-md hover:bg-gray-50"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>
      </nav>
    </header>

    <!-- BREADCRUMBS -->
    {breadcrumbs && breadcrumbs.length > 0 && (
      <Breadcrumb items={breadcrumbs} lang={lang} />
    )}

    <!-- MAIN CONTENT -->
    <main>
      <slot />
    </main>

    <!-- FOOTER -->
    <footer class="bg-[#F9FAFB] border-t border-gray-200 mt-auto">
      <div class="container-px mx-auto max-w-7xl px-4 py-12 md:py-16">
        <!-- 3-Column Layout -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12 mb-8">
          <!-- Column 1: Brand -->
          <div class="flex flex-col space-y-4">
            <h3 class="text-lg font-bold text-gray-900">Automation List</h3>
            <p class="text-sm text-[#6B7280]">
              {isGerman 
                ? "Entdecken Sie die besten Automatisierungstools und Workflows für Ihre Produktivitätsbedürfnisse."
                : "Discover the best automation tools and workflows for your productivity needs."}
            </p>
            <a 
              href={isGerman ? "/de/contact" : "/en/contact"}
              class="text-sm text-[#6B7280] hover:underline w-fit"
            >
              {isGerman ? "Über uns" : "About"}
            </a>
          </div>

          <!-- Column 2: Explore -->
          <div class="flex flex-col space-y-4">
            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide">
              {isGerman ? "Erkunden" : "Explore"}
            </h4>
            <nav class="flex flex-col space-y-2">
              <a 
                href={isGerman ? "/de/vendors" : "/en/vendors"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Anbieter" : "Vendors"}
              </a>
              <a 
                href={isGerman ? "/de/categories" : "/en/categories"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Kategorien" : "Categories"}
              </a>
              <a 
                href={isGerman ? "/de/technologies" : "/en/technologies"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Technologien" : "Technologies"}
              </a>
              <a 
                href={isGerman ? "/de/industries" : "/en/industries"}
                class="text-sm text-[#6B7280] hover:underline"
              >
                {isGerman ? "Branchen" : "Industries"}
              </a>
            </nav>
          </div>

          <!-- Column 3: Popular Countries -->
          <div class="flex flex-col space-y-4">
            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide">
              {isGerman ? "Beliebte Länder" : "Popular Countries"}
            </h4>
            <nav class="flex flex-col space-y-2">
              {popularCountries.length > 0 ? (
                popularCountries.map((country) => {
                  const countrySlug = countryToSlug(country);
                  const displayCountry = translateCountryName(country, lang);
                  return (
                    <a
                      href={isGerman ? `/de/country/${countrySlug}` : `/en/country/${countrySlug}`}
                      class="text-sm text-[#6B7280] hover:underline"
                    >
                      {displayCountry}
                    </a>
                  );
                })
              ) : (
                <span class="text-sm text-[#6B7280]">
                  {isGerman ? "Keine Länder verfügbar" : "No countries available"}
                </span>
              )}
            </nav>
          </div>
        </div>

        <!-- Divider -->
        <div class="border-t border-gray-200 pt-8">
          <!-- Copyright -->
          <div class="text-center text-sm text-[#6B7280] space-y-1">
            <p>© 2025 Automation List. All rights reserved.</p>
            <p>Made in Switzerland.</p>
            <p class="pt-2 space-x-4">
              <a href={isGerman ? "/de/impressum" : "/en/impressum"} class="hover:underline">
                {isGerman ? "Impressum" : "Impressum / Legal Notice"}
              </a>
              <a href={isGerman ? "/de/privacy" : "/en/privacy"} class="hover:underline">
                {isGerman ? "Datenschutz" : "Privacy Policy"}
              </a>
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- COOKIE CONSENT BANNER -->
    <CookieBanner />

    <!-- MOBILE MENU SCRIPT -->
    <script>
      const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");

      mobileMenuToggle?.addEventListener("click", () => {
        mobileMenu?.classList.toggle("hidden");
      });
    </script>
  </body>
</html>

