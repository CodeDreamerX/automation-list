---
export const prerender = false;

import { protectAdminRoute } from '../../../../lib/admin/authUtils';
import AdminLayout from '../../../../components/admin/AdminLayout.astro';
import PreviewTable from '../../../../components/admin/PreviewTable.astro';
import Statistics from '../../../../components/admin/Statistics.astro';
import { normalizeRow, validateRow, type ValidationResult } from '../../../../lib/admin/csvUtils';
import { readFile } from 'fs/promises';
import { join } from 'path';
import Papa from 'papaparse';

// Check authentication and redirect if not logged in
const redirectResponse = await protectAdminRoute(Astro.cookies, Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

// Get session ID from cookie
const sessionId = Astro.cookies.get('csv_upload_session')?.value;
const filename = Astro.cookies.get('csv_upload_filename')?.value || 'uploaded-file.csv';

if (!sessionId) {
  return Astro.redirect('/admin/vendors/csv/upload?error=no_session');
}

// Read the uploaded CSV file
let fileContent: string;
try {
  const tempFilePath = join(process.cwd(), '.temp', 'csv-uploads', `${sessionId}.csv`);
  fileContent = await readFile(tempFilePath, 'utf-8');
} catch (error) {
  console.error('Error reading uploaded file:', error);
  return Astro.redirect('/admin/vendors/csv/upload?error=file_not_found');
}

// Parse CSV using PapaParse
let parsedData: any[];
let parseErrors: any[] = [];

try {
  const parseResult = Papa.parse(fileContent, {
    header: true,
    skipEmptyLines: true,
    transformHeader: (header: string) => header.trim(),
  });
  
  parsedData = parseResult.data;
  parseErrors = parseResult.errors || [];
} catch (error) {
  console.error('Error parsing CSV:', error);
  return Astro.redirect('/admin/vendors/csv/upload?error=parse_error');
}

if (!parsedData || parsedData.length === 0) {
  return Astro.redirect('/admin/vendors/csv/upload?error=empty_csv');
}

// Normalize and clean all rows
const normalizedData: any[] = [];
const allUnknownColumns = new Set<string>();
const allSlugs: string[] = [];

for (const row of parsedData) {
  const { normalized, unknownColumns } = normalizeRow(row);
  
  // Add unknown columns to set
  unknownColumns.forEach(col => allUnknownColumns.add(col));
  
  // _categorySlugs is already generated by normalizeRow from category_slugs field
  // Clean other fields - split comma-separated values where appropriate
  // Technologies, languages, certifications, tags can be comma-separated
  const arrayFields = ['technologies', 'languages', 'certifications', 'tags'];
  for (const field of arrayFields) {
    if (normalized[field]) {
      const value = String(normalized[field]);
      normalized[field] = value.split(',').map(item => item.trim()).filter(Boolean).join(', ');
    }
  }
  
  normalizedData.push(normalized);
  
  // Collect slugs for duplicate checking
  if (normalized.slug) {
    allSlugs.push(normalized.slug);
  }
}

// Validate all rows
const validationResults: ValidationResult[] = normalizedData.map((row, index) => 
  validateRow(row, index, allSlugs)
);

// Calculate statistics
const rowCount = normalizedData.length;
const totalRowsWithErrors = validationResults.filter(r => r.missingRequired.length > 0).length;
const totalRowsWithWarnings = validationResults.filter(r => 
  r.invalidEmail || r.invalidWebsite || r.duplicateSlug
).length;
const unknownColumnsWarning = Array.from(allUnknownColumns);

// The import page will read the file from temp storage using sessionId
// No need to encode data here - we'll parse it again in the import page
---

<AdminLayout title="CSV Preview - Admin Panel" currentPath="/admin/vendors/csv">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">CSV Preview</h1>
        <p class="mt-1 text-sm text-gray-600">
          Review the parsed data from: <strong>{filename}</strong>
        </p>
      </div>
      <a
        href="/admin/vendors/csv"
        class="text-sm text-gray-600 hover:text-gray-900"
      >
        ← Back to CSV Import
      </a>
    </div>

    <!-- PARSE ERRORS -->
    {parseErrors.length > 0 && (
      <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
        <h3 class="text-sm font-semibold text-yellow-900 mb-2">CSV Parse Warnings</h3>
        <ul class="text-xs text-yellow-800 space-y-1">
          {parseErrors.slice(0, 5).map((error: any) => (
            <li>• Row {error.row}: {error.message}</li>
          ))}
          {parseErrors.length > 5 && (
            <li>... and {parseErrors.length - 5} more warnings</li>
          )}
        </ul>
      </div>
    )}

    <!-- STATISTICS -->
    <Statistics 
      rowCount={rowCount}
      totalRowsWithErrors={totalRowsWithErrors}
      totalRowsWithWarnings={totalRowsWithWarnings}
      unknownColumnsWarning={unknownColumnsWarning}
    />

    <!-- PREVIEW TABLE -->
    <PreviewTable 
      normalizedData={normalizedData}
      validationResults={validationResults}
      rowCount={rowCount}
    />

    <!-- IMPORT FORM -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Ready to Import?</h2>
      <p class="text-sm text-gray-600 mb-6">
        {totalRowsWithErrors > 0 ? (
          <span class="text-red-600 font-medium">
            Warning: {totalRowsWithErrors} row{totalRowsWithErrors !== 1 ? 's' : ''} have errors and may not import correctly.
          </span>
        ) : (
          <span>All rows are valid and ready to import.</span>
        )}
      </p>
      
      <form id="import-form" class="space-y-4">
        <input type="hidden" name="sessionId" value={sessionId} />
        
        <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
          <button
            type="submit"
            class="btn-primary"
            id="import-button"
          >
            Import {rowCount} Vendor{rowCount !== 1 ? 's' : ''}
          </button>
          <a
            href="/admin/vendors/csv/upload"
            class="btn-secondary"
          >
            Upload Different File
          </a>
        </div>
      </form>

      <script>
        const form = document.getElementById('import-form');
        const importButton = document.getElementById('import-button');
        
        if (form && importButton) {
          // Save original button text
          const originalButtonText = importButton.textContent;
          
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Disable button and show loading state
            importButton.disabled = true;
            importButton.textContent = 'Importing...';
            
            try {
              const formData = new FormData(form);
              const response = await fetch('/admin/vendors/csv/import', {
                method: 'POST',
                body: formData,
              });
              
              if (!response.ok) {
                throw new Error('Import failed');
              }
              
              const results = await response.json();
              
              // Store results in sessionStorage
              sessionStorage.setItem('csvImportResults', JSON.stringify(results));
              
              // Redirect to results page with summary counts
              const params = new URLSearchParams({
                imported: results.imported?.toString() || '0',
                failed: results.failed?.toString() || '0',
                skipped: results.skipped?.toString() || '0',
                warningsCount: results.warnings?.length?.toString() || '0',
                errorsCount: results.errors?.length?.toString() || '0',
              });
              
              window.location.href = `/admin/vendors/csv/results?${params.toString()}`;
            } catch (error) {
              console.error('Import error:', error);
              alert('An error occurred during import. Please try again.');
              importButton.disabled = false;
              importButton.textContent = originalButtonText;
            }
          });
        }
      </script>
    </div>

    <!-- VALIDATION NOTES -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <h3 class="text-sm font-semibold text-gray-900 mb-2">Validation Notes</h3>
      <ul class="text-xs text-gray-600 space-y-1">
        <li>• <span class="bg-red-200 px-1 rounded">Red background</span> indicates missing required fields</li>
        <li>• <span class="bg-yellow-200 px-1 rounded">Yellow background</span> indicates warnings (invalid email, website, or duplicate slug)</li>
        <li>• Required fields: name, slug, country, category_slugs</li>
        <li>• Category slugs field should contain semicolon-separated category slugs (e.g., "plcs;scada-hmi")</li>
        <li>• Website URLs should start with http:// or https://</li>
      </ul>
    </div>
  </div>
</AdminLayout>

