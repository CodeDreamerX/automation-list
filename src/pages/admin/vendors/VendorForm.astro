---
export const prerender = false;

import { supabase } from '../../../lib/supabaseClient';
import { protectAdminRoute } from '../../../lib/admin/authUtils';
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import VendorForm from '../../../components/admin/VendorForm.astro';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  return Astro.redirect('/api/admin/logout');
}

// Check authentication and redirect if not logged in
// Note: Middleware also handles this, but keeping as defensive check
const redirectResponse = await protectAdminRoute(Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

// Fetch all categories from Supabase
const { data: categories } = await supabase
  .from("categories")
  .select("*")
  .eq("is_active", true)
  .order("order_index", { ascending: true });

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  
  // Check if slug already exists (read-only query, using anon client is OK)
  const slug = formData.get('slug')?.toString();
  if (slug) {
    const { data: existingVendor } = await supabase
      .from('vendors')
      .select('id')
      .eq('slug', slug)
      .maybeSingle();
    
    if (existingVendor) {
      console.error('Error: Slug already exists');
      // Redirect back with error
      return Astro.redirect('/admin/vendors/VendorForm?error=slug_exists');
    }
  }

  // Create vendor via API endpoint
  // Send FormData directly to API endpoint (includes category_slugs)
  // Supabase auth cookies are automatically included via credentials: 'include'
  const response = await fetch(`${Astro.url.origin}/api/admin/create-vendor`, {
    method: 'POST',
    credentials: 'include',
    body: formData,
  });

  if (!response.ok) {
    const error = await response.json();
    console.error('Error creating vendor:', error);
    // Redirect back with error
    return Astro.redirect('/admin/vendors/VendorForm?error=create_failed');
  }
  
  const result = await response.json();
  if (result.data && result.data.id) {
    // Redirect to edit page of the newly created vendor
    return Astro.redirect(`/admin/edit/${result.data.id}`);
  } else {
    // Redirect back to admin panel if creation failed
    return Astro.redirect('/admin');
  }
}

// Empty vendor object for new vendor form
const emptyVendor = null;

// Check for error messages
const error = Astro.url.searchParams.get('error');
let errorMessage = '';
if (error === 'slug_exists') {
  errorMessage = 'A vendor with this slug already exists. Please choose a different slug.';
} else if (error === 'create_failed') {
  errorMessage = 'Failed to create vendor. Please check all required fields and try again.';
}
---

<AdminLayout title="Create New Vendor - Admin Panel" currentPath="/admin/vendors">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Create New Vendor</h1>
        <p class="mt-1 text-sm text-gray-600">
          Add a new vendor to the Automation List directory
        </p>
      </div>
      <a
        href="/admin"
        class="text-sm text-gray-600 hover:text-gray-900"
      >
        ‚Üê Back to Vendor List
      </a>
    </div>

    <!-- ERROR MESSAGE -->
    {errorMessage && (
      <div class="bg-red-50 border border-red-200 rounded-md p-4">
        <p class="text-sm text-red-700">{errorMessage}</p>
      </div>
    )}

    <!-- VENDOR FORM -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <VendorForm vendor={emptyVendor} categories={categories || []} />
    </div>
  </div>
</AdminLayout>

