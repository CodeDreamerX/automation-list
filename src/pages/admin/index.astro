---
export const prerender = false;

import { supabaseAdmin } from '../../lib/supabaseAdminClient';
import { createSupabaseServerClient } from '../../lib/supabaseServer';
import { protectAdminRoute } from '../../lib/admin/authUtils';
import AdminLayout from '../../components/admin/AdminLayout.astro';
import VendorTable from '../../components/admin/VendorTable.astro';
import { normalizeVendors } from '../../lib/vendors/vendorUtils';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  return Astro.redirect('/api/admin/logout');
}

// Check authentication and redirect if not logged in
// Note: Middleware also handles this, but keeping as defensive check
const redirectResponse = await protectAdminRoute(Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

// Create Supabase server client for authenticated operations
const supabase = createSupabaseServerClient(Astro.cookies);

// Get search query from URL
const searchQuery = Astro.url.searchParams.get('q') || '';

// Check for CSV import success notice
const importSuccess = Astro.url.searchParams.get('import_success') === 'true';
const importSuccessCount = parseInt(Astro.url.searchParams.get('success') || '0');
const importSkippedCount = parseInt(Astro.url.searchParams.get('skipped') || '0');
const importErrorsCount = parseInt(Astro.url.searchParams.get('errors') || '0');
const importWarningsCount = parseInt(Astro.url.searchParams.get('warnings') || '0');

// Handle actions (delete, toggle featured, change plan, change priority)
if (Astro.request.method === 'POST') {
  // Verify authentication
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return Astro.redirect('/admin/login');
  }

  // Verify admin role
  const { data: roleData } = await supabase
    .from('user_roles')
    .select('role')
    .eq('user_id', user.id)
    .limit(1)
    .maybeSingle();

  if (roleData?.role !== 'admin') {
    return Astro.redirect('/admin/login');
  }

  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();
  const vendorId = formData.get('vendor_id')?.toString();
  
  if (action && vendorId) {
    if (action === 'delete') {
      const { error } = await supabaseAdmin
        .from('vendors')
        .delete()
        .eq('id', vendorId);
      
      if (error) {
        console.error('Error deleting vendor:', error);
      }
    } else if (action === 'toggle_featured') {
      // First get current featured status
      const { data: vendor } = await supabaseAdmin
        .from('vendors')
        .select('featured')
        .eq('id', vendorId)
        .single();
      
      if (vendor) {
        const { error } = await supabaseAdmin
          .from('vendors')
          .update({ featured: !vendor.featured, updated_at: new Date().toISOString() })
          .eq('id', vendorId);
        
        if (error) {
          console.error('Error toggling featured:', error);
        }
      }
    } else if (action === 'change_plan') {
      const plan = formData.get('plan')?.toString();
      if (plan && ['free', 'pro', 'featured', 'deactivated'].includes(plan)) {
        const { error } = await supabaseAdmin
          .from('vendors')
          .update({ plan: plan, updated_at: new Date().toISOString() })
          .eq('id', vendorId);
        
        if (error) {
          console.error('Error changing plan:', error);
        }
      }
    } else if (action === 'change_priority') {
      const priority = formData.get('priority')?.toString();
      if (priority) {
        const priorityNum = parseInt(priority);
        if (priorityNum >= 1 && priorityNum <= 5) {
          const { error } = await supabaseAdmin
            .from('vendors')
            .update({ priority: priorityNum, updated_at: new Date().toISOString() })
            .eq('id', vendorId);
          
          if (error) {
            console.error('Error changing priority:', error);
          }
        }
      }
    }
  }
  
  return Astro.redirect('/admin');
}

// Handle GET delete action (with confirmation)
if (Astro.request.method === 'GET' && Astro.url.searchParams.get('action') === 'delete') {
  // Verify authentication
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return Astro.redirect('/admin/login');
  }

  // Verify admin role
  const { data: roleData } = await supabase
    .from('user_roles')
    .select('role')
    .eq('user_id', user.id)
    .limit(1)
    .maybeSingle();

  if (roleData?.role !== 'admin') {
    return Astro.redirect('/admin/login');
  }

  const vendorId = Astro.url.searchParams.get('id');
  if (vendorId) {
    const { error } = await supabaseAdmin
      .from('vendors')
      .delete()
      .eq('id', vendorId);
    
    if (error) {
      console.error('Error deleting vendor:', error);
    }
  }
  return Astro.redirect('/admin');
}

// Fetch all vendors with vendor_categories, vendor_technologies, and vendor_industries
const { data: vendors, error } = await supabaseAdmin
  .from('vendors')
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    ),
    vendor_technologies (
      technologies:technologies (
        id,
        slug,
        name_en,
        name_de
      )
    ),
    vendor_industries (
      industries:industries (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching vendors:', error);
}

// Normalize category, technology, and industry data shape
const normalizedVendors = normalizeVendors(vendors || [], {
  includeCategories: true,
  includeTechnologies: true,
  includeIndustries: true
});
---

<AdminLayout title="Vendor Management - Admin Panel" currentPath="/admin">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Vendor Management</h1>
        <p class="mt-1 text-sm text-gray-600">
          Manage all vendors in the Automation List directory
        </p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
          Total: {normalizedVendors.length} vendors
        </div>
        <button
          type="button"
          id="refresh-vendor-counts-btn"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
        >
          Refresh vendor counts
        </button>
        <a
          href="/admin/vendors/csv"
          class="btn-secondary"
        >
          CSV Import
        </a>
        <a
          href="/admin/new"
          class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-900 transition-colors text-sm font-medium"
        >
          + Create New Vendor
        </a>
      </div>
    </div>

    <!-- CSV IMPORT SUCCESS NOTICE -->
    {importSuccess && (
      <div class="bg-green-50 border border-green-200 rounded-md p-4">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="text-sm font-semibold text-green-900 mb-2">CSV Import Completed</h3>
            <div class="text-sm text-green-800 space-y-1">
              <p>✓ Successfully imported: <strong>{importSuccessCount}</strong> vendor{importSuccessCount !== 1 ? 's' : ''}</p>
              {importSkippedCount > 0 && (
                <p>⚠ Skipped: <strong>{importSkippedCount}</strong> row{importSkippedCount !== 1 ? 's' : ''} (duplicates or missing required fields)</p>
              )}
              {importErrorsCount > 0 && (
                <p class="text-red-700">✗ Errors: <strong>{importErrorsCount}</strong> row{importErrorsCount !== 1 ? 's' : ''} failed to import</p>
              )}
              {importWarningsCount > 0 && (
                <p class="text-yellow-700">⚠ Warnings: <strong>{importWarningsCount}</strong> row{importWarningsCount !== 1 ? 's' : ''} had warnings</p>
              )}
            </div>
          </div>
          <a
            href="/admin"
            class="text-green-700 hover:text-green-900 text-sm font-medium"
          >
            ×
          </a>
        </div>
      </div>
    )}

    <!-- SEARCH BAR -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <form method="GET" action="/admin" class="flex gap-4">
        <input
          type="text"
          name="q"
          value={searchQuery}
          placeholder="Search by name, slug, technologies, category, or country..."
          class="flex-1 border border-gray-300 rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        />
        <button
          type="submit"
          class="px-6 py-2 bg-black text-white rounded-md hover:bg-gray-900 transition-colors text-sm font-medium"
        >
          Search
        </button>
        {searchQuery && (
          <a
            href="/admin"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium"
          >
            Clear
          </a>
        )}
      </form>
    </div>

    <!-- VENDOR TABLE -->
    <VendorTable vendors={normalizedVendors} searchQuery={searchQuery} />

    <!-- QUICK ACTIONS INFO -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <h3 class="text-sm font-semibold text-gray-900 mb-2">Quick Actions</h3>
      <ul class="text-xs text-gray-600 space-y-1">
        <li>• Click <strong>Edit</strong> to modify vendor details</li>
        <li>• Click <strong>Delete</strong> to remove a vendor (this action cannot be undone)</li>
        <li>• Use the search bar to filter vendors by name, slug, technologies, category, or country</li>
      </ul>
    </div>
  </div>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('refresh-vendor-counts-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
          // Ask for confirmation
          if (!confirm('Are you sure you want to refresh vendor counts? This will update the materialized views.')) {
            return;
          }

          try {
            const response = await fetch('/api/admin/refresh-counts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
            });

            const data = await response.json();

            if (response.ok && data.success) {
              alert('Vendor counts refreshed successfully!');
            } else {
              alert('Error: ' + (data.error || 'Failed to refresh vendor counts'));
            }
          } catch (error) {
            alert('Error: Failed to refresh vendor counts. Please try again.');
            console.error('Error refreshing vendor counts:', error);
          }
        });
      }
    });
  </script>
</AdminLayout>
