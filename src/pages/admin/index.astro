---
export const prerender = false;

import { supabase } from '../../lib/supabaseClient';
import { checkAuth, protectAdminRoute, getCookieHeader } from '../../lib/admin/authUtils';
import AdminLayout from '../../components/admin/AdminLayout.astro';
import VendorTable from '../../components/admin/VendorTable.astro';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  const { clearAuthCookie } = await import('../../lib/admin/authUtils');
  clearAuthCookie(Astro.cookies);
  return Astro.redirect('/admin/login?logout=true');
}

// Check authentication and redirect if not logged in
// Note: Middleware also handles this, but keeping as defensive check
const redirectResponse = await protectAdminRoute(Astro.cookies, Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

// Get search query from URL
const searchQuery = Astro.url.searchParams.get('q') || '';

// Handle actions (delete, toggle featured, change plan, change priority)
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();
  const vendorId = formData.get('vendor_id')?.toString();
  
  if (action && vendorId) {
    // Forward cookies from the original request using helper function
    const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
    
    if (action === 'delete') {
      const response = await fetch(`${Astro.url.origin}/api/admin/delete-vendor`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': cookieHeader,
        },
        credentials: 'include',
        body: JSON.stringify({ id: vendorId }),
      });
      
      if (!response.ok) {
        const error = await response.json();
        console.error('Error deleting vendor:', error);
      }
    } else if (action === 'toggle_featured') {
      // First get current featured status
      const { data: vendor } = await supabase
        .from('vendors')
        .select('featured')
        .eq('id', vendorId)
        .single();
      
      if (vendor) {
        const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
        const response = await fetch(`${Astro.url.origin}/api/admin/update-vendor`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Cookie': cookieHeader,
          },
          credentials: 'include',
          body: JSON.stringify({ 
            id: vendorId,
            featured: !vendor.featured,
          }),
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('Error toggling featured:', error);
        }
      }
    } else if (action === 'change_plan') {
      const plan = formData.get('plan')?.toString();
      if (plan && ['free', 'pro', 'featured'].includes(plan)) {
        const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
        const response = await fetch(`${Astro.url.origin}/api/admin/update-vendor`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Cookie': cookieHeader,
          },
          credentials: 'include',
          body: JSON.stringify({ 
            id: vendorId,
            plan: plan,
          }),
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('Error changing plan:', error);
        }
      }
    } else if (action === 'change_priority') {
      const priority = formData.get('priority')?.toString();
      if (priority) {
        const priorityNum = parseInt(priority);
        if (priorityNum >= 1 && priorityNum <= 5) {
          const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
          const response = await fetch(`${Astro.url.origin}/api/admin/update-vendor`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Cookie': cookieHeader,
            },
            credentials: 'include',
            body: JSON.stringify({ 
              id: vendorId,
              priority: priorityNum,
            }),
          });
          
          if (!response.ok) {
            const error = await response.json();
            console.error('Error changing priority:', error);
          }
        }
      }
    }
  }
  
  return Astro.redirect('/admin');
}

// Handle GET delete action (with confirmation)
if (Astro.request.method === 'GET' && Astro.url.searchParams.get('action') === 'delete') {
  const vendorId = Astro.url.searchParams.get('id');
  if (vendorId) {
    // Forward cookies from the original request using helper function
    const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
    
    const response = await fetch(`${Astro.url.origin}/api/admin/delete-vendor`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cookie': cookieHeader,
      },
      credentials: 'include',
      body: JSON.stringify({ id: vendorId }),
    });
    
    if (!response.ok) {
      const error = await response.json();
      console.error('Error deleting vendor:', error);
    }
  }
  return Astro.redirect('/admin');
}

// Fetch all vendors with vendor_categories
const { data: vendors, error } = await supabase
  .from('vendors')
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching vendors:', error);
}
---

<AdminLayout title="Vendor Management - Admin Panel" currentPath="/admin">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Vendor Management</h1>
        <p class="mt-1 text-sm text-gray-600">
          Manage all vendors in the Automation List directory
        </p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
          Total: {vendors?.length || 0} vendors
        </div>
        <a
          href="/admin/new"
          class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-900 transition-colors text-sm font-medium"
        >
          + Create New Vendor
        </a>
      </div>
    </div>

    <!-- SEARCH BAR -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <form method="GET" action="/admin" class="flex gap-4">
        <input
          type="text"
          name="q"
          value={searchQuery}
          placeholder="Search by name, slug, technologies, category, or country..."
          class="flex-1 border border-gray-300 rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        />
        <button
          type="submit"
          class="px-6 py-2 bg-black text-white rounded-md hover:bg-gray-900 transition-colors text-sm font-medium"
        >
          Search
        </button>
        {searchQuery && (
          <a
            href="/admin"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium"
          >
            Clear
          </a>
        )}
      </form>
    </div>

    <!-- VENDOR TABLE -->
    <VendorTable vendors={vendors || []} searchQuery={searchQuery} />

    <!-- QUICK ACTIONS INFO -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <h3 class="text-sm font-semibold text-gray-900 mb-2">Quick Actions</h3>
      <ul class="text-xs text-gray-600 space-y-1">
        <li>• Click <strong>Edit</strong> to modify vendor details</li>
        <li>• Click <strong>Delete</strong> to remove a vendor (this action cannot be undone)</li>
        <li>• Use the search bar to filter vendors by name, slug, technologies, category, or country</li>
      </ul>
    </div>
  </div>
</AdminLayout>
