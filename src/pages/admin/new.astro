---
export const prerender = false;

import { supabaseAdmin } from '../../lib/supabaseAdminClient';
import { createSupabaseServerClient } from '../../lib/supabaseServer';
import { protectAdminRoute } from '../../lib/admin/authUtils';
import AdminLayout from '../../components/admin/AdminLayout.astro';
import VendorForm from '../../components/admin/VendorForm.astro';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  return Astro.redirect('/api/admin/logout');
}

// Check authentication and redirect if not logged in
// Note: Middleware also handles this, but keeping as defensive check
const redirectResponse = await protectAdminRoute(Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

// Create Supabase server client for authenticated operations
const supabase = createSupabaseServerClient(Astro.cookies);

// Fetch all categories from Supabase
const { data: categories } = await supabaseAdmin
  .from('categories')
  .select('id, slug, name_en, name_de')
  .order('order_index', { ascending: true, nullsFirst: false })
  .order('name_en', { ascending: true });

// Fetch all technologies from Supabase
const { data: technologies } = await supabaseAdmin
  .from('technologies')
  .select('id, slug, name_en, name_de')
  .order('name_en', { ascending: true });

// Fetch all industries from Supabase
const { data: industries } = await supabaseAdmin
  .from('industries')
  .select('id, slug, name_en, name_de')
  .order('name_en', { ascending: true });

// Handle form submission
if (Astro.request.method === 'POST') {
  // Verify authentication
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return Astro.redirect('/admin/login');
  }

  // Verify admin role
  const { data: roleData } = await supabase
    .from('user_roles')
    .select('role')
    .eq('user_id', user.id)
    .limit(1)
    .maybeSingle();

  if (roleData?.role !== 'admin') {
    return Astro.redirect('/admin/login');
  }

  const formData = await Astro.request.formData();
  
  // Check if slug already exists
  const slug = formData.get('slug')?.toString();
  if (slug) {
    const { data: existingVendor } = await supabaseAdmin
      .from('vendors')
      .select('id')
      .eq('slug', slug)
      .maybeSingle();
    
    if (existingVendor) {
      console.error('Error: Slug already exists');
      return Astro.redirect('/admin/new?error=slug_exists');
    }
  }

  // Extract category slugs from form data
  const categorySlugs = formData.getAll("category_slugs")
    .map((slug) => String(slug).trim())
    .filter((slug) => slug.length > 0);
  
  // Extract technology slugs from form data
  const technologySlugs = formData.getAll("technology_slugs")
    .map((slug) => String(slug).trim())
    .filter((slug) => slug.length > 0);
  
  // Extract industry slugs from form data
  const industrySlugs = formData.getAll("industry_slugs")
    .map((slug) => String(slug).trim())
    .filter((slug) => slug.length > 0);
  
  // Build insertData from form fields
  const insertData: any = {
    name: formData.get('name')?.toString() || null,
    slug: formData.get('slug')?.toString() || null,
    description_en: formData.get('description_en')?.toString() || null,
    description_de: formData.get('description_de')?.toString() || null,
    website: formData.get('website')?.toString() || null,
    email: formData.get('email')?.toString() || null,
    phone: formData.get('phone')?.toString() || null,
    address: formData.get('address')?.toString() || null,
    city: formData.get('city')?.toString() || null,
    region: formData.get('region')?.toString() || null,
    country: formData.get('country')?.toString() || null,
    languages: formData.get('languages')?.toString() || null,
    certifications: formData.get('certifications')?.toString() || null,
    tags: formData.get('tags')?.toString() || null,
    year_founded: formData.get('year_founded')?.toString() ? Number(formData.get('year_founded')!.toString()) : null,
    employee_count: formData.get('employee_count')?.toString() ? Number(formData.get('employee_count')!.toString()) : null,
    hourly_rate: formData.get('hourly_rate')?.toString() || null,
    plan: formData.get('plan')?.toString() || 'free',
    priority: formData.get('priority')?.toString() ? parseInt(formData.get('priority')!.toString()) : null,
    featured: formData.get('featured') === 'on',
    og_member: formData.get('og_member') === 'on',
    featured_until: formData.get('featured_until')?.toString() || null,
    meta_title: formData.get('meta_title')?.toString() || null,
    meta_description: formData.get('meta_description')?.toString() || null,
    canonical_url: formData.get('canonical_url')?.toString() || null,
    logo_url: formData.get('logo_url')?.toString() || null,
    logo_width: formData.get('logo_width')?.toString() ? Number(formData.get('logo_width')!.toString()) : null,
    logo_height: formData.get('logo_height')?.toString() ? Number(formData.get('logo_height')!.toString()) : null,
    logo_format: formData.get('logo_format')?.toString() || null,
    logo_alt: formData.get('logo_alt')?.toString() || null,
    logo_background_variant: (() => {
      const formVariant = formData.get('logo_background_variant')?.toString() || null;
      if (!formVariant) return null;
      // Map form values (white, light, gray, dark, brand) to DB values (light, neutral, dark, brand)
      const variantMap: Record<string, string> = {
        'white': 'light',
        'light': 'light',
        'gray': 'neutral',
        'neutral': 'neutral',
        'dark': 'dark',
        'brand': 'brand'
      };
      return variantMap[formVariant.toLowerCase()] || 'light';
    })(),
  };

  // Normalize website URL: add https:// if missing
  if (insertData.website && typeof insertData.website === 'string') {
    const website = insertData.website.trim();
    if (website && !website.match(/^https?:\/\//i)) {
      insertData.website = 'https://' + website;
    }
  }


  // Add timestamps
  insertData.created_at = new Date().toISOString();
  insertData.updated_at = new Date().toISOString();

  // Create vendor using admin client and retrieve new vendor ID
  const { data: vendor, error: createError } = await supabaseAdmin
    .from('vendors')
    .insert([insertData])
    .select('id')
    .single();

  if (createError) {
    console.error('Error creating vendor:', createError);
    return Astro.redirect('/admin/new?error=create_failed');
  }

  // Insert vendor_categories entries if category slugs were provided
  if (categorySlugs.length > 0 && vendor?.id) {
    for (const slug of categorySlugs) {
      const { data: cat } = await supabaseAdmin
        .from("categories")
        .select("id")
        .eq("slug", slug)
        .single();

      if (cat?.id) {
        await supabaseAdmin
          .from("vendor_categories")
          .insert({
            vendor_id: vendor.id,
            category_id: cat.id
          });
      }
    }
  }

  // Insert vendor_technologies entries if technology slugs were provided
  if (technologySlugs.length > 0 && vendor?.id) {
    for (const slug of technologySlugs) {
      const { data: tech } = await supabaseAdmin
        .from("technologies")
        .select("id")
        .eq("slug", slug)
        .single();

      if (tech?.id) {
        await supabaseAdmin
          .from("vendor_technologies")
          .insert({
            vendor_id: vendor.id,
            technology_id: tech.id
          });
      }
    }
  }

  // Insert vendor_industries entries if industry slugs were provided
  if (industrySlugs.length > 0 && vendor?.id) {
    for (const slug of industrySlugs) {
      const { data: industry } = await supabaseAdmin
        .from("industries")
        .select("id")
        .eq("slug", slug)
        .single();

      if (industry?.id) {
        await supabaseAdmin
          .from("vendor_industries")
          .insert({
            vendor_id: vendor.id,
            industry_id: industry.id
          });
      }
    }
  }

  // Redirect to edit page of the newly created vendor
  if (vendor?.id) {
    return Astro.redirect(`/admin/edit/${vendor.id}`);
  } else {
    return Astro.redirect('/admin');
  }
}

// Empty vendor object for new vendor form
const emptyVendor = null;

// Check for error messages
const error = Astro.url.searchParams.get('error');
let errorMessage = '';
if (error === 'slug_exists') {
  errorMessage = 'A vendor with this slug already exists. Please choose a different slug.';
} else if (error === 'create_failed') {
  errorMessage = 'Failed to create vendor. Please check all required fields and try again.';
}
---

<AdminLayout title="Create New Vendor - Admin Panel" currentPath="/admin">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Create New Vendor</h1>
        <p class="mt-1 text-sm text-gray-600">
          Add a new vendor to the Automation List directory
        </p>
      </div>
      <a
        href="/admin"
        class="text-sm text-gray-600 hover:text-gray-900"
      >
        ‚Üê Back to Vendor List
      </a>
    </div>

    <!-- ERROR MESSAGE -->
    {errorMessage && (
      <div class="bg-red-50 border border-red-200 rounded-md p-4">
        <p class="text-sm text-red-700">{errorMessage}</p>
      </div>
    )}

    <!-- VENDOR FORM -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <VendorForm vendor={emptyVendor} categories={categories || []} technologies={technologies || []} industries={industries || []} />
    </div>
  </div>
</AdminLayout>

