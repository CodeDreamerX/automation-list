---
export const prerender = false;

import { supabase } from '../../../lib/supabaseClient';
import { protectAdminRoute } from '../../../lib/admin/authUtils';
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import VendorForm from '../../../components/admin/VendorForm.astro';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  const { clearAuthCookie } = await import('../../../lib/admin/authUtils');
  clearAuthCookie(Astro.cookies);
  return Astro.redirect('/admin/login?logout=true');
}

// Check authentication and redirect if not logged in
const redirectResponse = await protectAdminRoute(Astro.cookies);
if (redirectResponse) {
  return redirectResponse;
}

const { id } = Astro.params;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  
  // Prepare update object
  const updateData: any = {
    name: formData.get('name')?.toString() || null,
    slug: formData.get('slug')?.toString() || null,
    description: formData.get('description')?.toString() || null,
    website: formData.get('website')?.toString() || null,
    email: formData.get('email')?.toString() || null,
    phone: formData.get('phone')?.toString() || null,
    address: formData.get('address')?.toString() || null,
    city: formData.get('city')?.toString() || null,
    region: formData.get('region')?.toString() || null,
    country: formData.get('country')?.toString() || null,
    category: formData.get('category')?.toString() || null,
    technologies: formData.get('technologies')?.toString() || null,
    languages: formData.get('languages')?.toString() || null,
    certifications: formData.get('certifications')?.toString() || null,
    tags: formData.get('tags')?.toString() || null,
    industries: formData.get('industries')?.toString() || null,
    year_founded: formData.get('year_founded')?.toString() || null,
    employee_count: formData.get('employee_count')?.toString() || null,
    hourly_rate: formData.get('hourly_rate')?.toString() || null,
    plan: formData.get('plan')?.toString() || 'free',
    priority: formData.get('priority')?.toString() ? parseInt(formData.get('priority')!.toString()) : null,
    featured: formData.get('featured') === 'on',
    og_member: formData.get('og_member') === 'on',
    featured_until: formData.get('featured_until')?.toString() || null,
    meta_title: formData.get('meta_title')?.toString() || null,
    meta_description: formData.get('meta_description')?.toString() || null,
    canonical_url: formData.get('canonical_url')?.toString() || null,
    logo_url: formData.get('logo_url')?.toString() || null,
    updated_at: new Date().toISOString(),
  };

  // Handle categories array
  const categoriesInput = formData.get('categories')?.toString() || '';
  if (categoriesInput) {
    updateData.categories = categoriesInput.split(',').map(c => c.trim()).filter(Boolean);
  } else {
    updateData.categories = null;
  }

  // Update vendor in database
  const { error } = await supabase
    .from('vendors')
    .update(updateData)
    .eq('id', id);

  if (error) {
    console.error('Error updating vendor:', error);
    // In a real app, you'd want to show this error to the user
  } else {
    // Redirect back to admin panel after successful update
    return Astro.redirect('/admin');
  }
}

// Fetch vendor by ID
const { data: vendor, error } = await supabase
  .from('vendors')
  .select('*')
  .eq('id', id)
  .maybeSingle();

if (error) {
  console.error('Error fetching vendor:', error);
}

if (!vendor) {
  return Astro.redirect('/admin');
}
---

<AdminLayout title={`Edit Vendor: ${vendor.name} - Admin Panel`} currentPath="/admin">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Edit Vendor</h1>
        <p class="mt-1 text-sm text-gray-600">
          {vendor.name || 'Vendor'}
        </p>
      </div>
      <a
        href="/admin"
        class="text-sm text-gray-600 hover:text-gray-900"
      >
        ‚Üê Back to Vendor List
      </a>
    </div>

    <!-- VENDOR FORM -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <VendorForm vendor={vendor} />
    </div>
  </div>
</AdminLayout>

