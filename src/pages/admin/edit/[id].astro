---
export const prerender = false;

import { supabase } from '../../../lib/supabaseClient';
import { protectAdminRoute, getCookieHeader } from '../../../lib/admin/authUtils';
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import VendorForm from '../../../components/admin/VendorForm.astro';

// Handle logout first (before auth check)
if (Astro.url.searchParams.get('logout') === 'true') {
  const { clearAuthCookie } = await import('../../../lib/admin/authUtils');
  clearAuthCookie(Astro.cookies);
  return Astro.redirect('/admin/login?logout=true');
}

// Check authentication and redirect if not logged in
// Note: Middleware also handles this, but keeping as defensive check
const redirectResponse = await protectAdminRoute(Astro.cookies, Astro.locals);
if (redirectResponse) {
  return redirectResponse;
}

const { id } = Astro.params;

// Fetch all categories from Supabase
const { data: categories } = await supabase
  .from('categories')
  .select('id, slug, name_en, name_de')
  .order('order_index', { ascending: true, nullsLast: true })
  .order('name_en', { ascending: true });

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  // Update vendor via API endpoint
  // Forward cookies from the original request using helper function
  const cookieHeader = getCookieHeader(Astro.cookies, Astro.request);
  
  // Send FormData directly to API endpoint (includes category_slugs)
  const response = await fetch(`${Astro.url.origin}/api/admin/update-vendor`, {
    method: 'POST',
    headers: {
      'Cookie': cookieHeader,
    },
    credentials: 'include',
    body: formData,
  });

  if (!response.ok) {
    const error = await response.json();
    console.error('Error updating vendor:', error);
    // In a real app, you'd want to show this error to the user
  } else {
    // Redirect back to admin panel after successful update
    return Astro.redirect('/admin');
  }
}

// Fetch vendor by ID with vendor_categories
const { data: vendor, error } = await supabase
  .from('vendors')
  .select(`
    *,
    vendor_categories (
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `)
  .eq('id', id)
  .maybeSingle();

if (error) {
  console.error('Error fetching vendor:', error);
}

if (!vendor) {
  return Astro.redirect('/admin');
}
---

<AdminLayout title={`Edit Vendor: ${vendor.name} - Admin Panel`} currentPath="/admin">
  <div class="space-y-6">
    <!-- HEADER -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Edit Vendor</h1>
        <p class="mt-1 text-sm text-gray-600">
          {vendor.name || 'Vendor'}
        </p>
      </div>
      <a
        href="/admin"
        class="text-sm text-gray-600 hover:text-gray-900"
      >
        ‚Üê Back to Vendor List
      </a>
    </div>

    <!-- VENDOR FORM -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <VendorForm vendor={vendor} categories={categories || []} />
    </div>
  </div>
</AdminLayout>

