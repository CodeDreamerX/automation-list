---
export const prerender = false;

import { verifyPassword, setAuthCookie, clearAuthCookie } from '../../lib/admin/authUtils';
import BaseLayout from '../../layouts/BaseLayout.astro';

let passwordError = false;
let logoutSuccess = false;

// Handle logout first (before checking if already logged in)
if (Astro.url.searchParams.get('logout') === 'true') {
  clearAuthCookie(Astro.cookies);
  logoutSuccess = true;
  // Continue to show login form (don't redirect)
}

// Check if already logged in (but only if not logging out)
if (Astro.url.searchParams.get('logout') !== 'true') {
  const existingCookie = Astro.cookies.get('adminSession');
  if (existingCookie?.value === '1') {
    return Astro.redirect('/admin');
  }
}

// Handle POST request
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const submittedPassword = formData.get('password')?.toString() || '';
  
  if (verifyPassword(submittedPassword)) {
    setAuthCookie(Astro.cookies);
    return Astro.redirect('/admin');
  } else {
    passwordError = true;
  }
}

const engNavItems = [
  { label: "Home", href: "/en/" },
  { label: "Features", href: "/en/features" },
  { label: "Categories", href: "/en/categories" },
  { label: "Vendors", href: "/en/vendors" },
  { label: "Blog", href: "/en/blog" },
  { label: "Contact", href: "/en/contact" },
];
---

<BaseLayout 
  title="Admin Login - Automation List"
  description="Admin panel login"
  lang="en"
  navItems={engNavItems}
>
  <section class="min-h-screen flex items-center justify-center bg-gray-50 py-16">
    <div class="container-px mx-auto max-w-md">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Admin Login</h1>
        
        {logoutSuccess && (
          <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-md text-green-700 text-sm">
            You have been successfully logged out.
          </div>
        )}
        
        {passwordError && (
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
            Invalid password. Please try again.
          </div>
        )}
        
        <form method="POST" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
              autofocus
            />
          </div>
          
          <button
            type="submit"
            class="w-full px-6 py-3 bg-black text-white rounded-md hover:bg-gray-900 transition-colors font-medium"
          >
            Login
          </button>
        </form>
      </div>
    </div>
  </section>
</BaseLayout>

