---
// Server-Side Rendering (SSR) - This page is rendered on-demand
// See STATIC_GENERATION_STRATEGY.md for details

export const prerender = false;

import BaseLayout from "../../../layouts/BaseLayout.astro";
import VendorCard from "../../../components/VendorCard.astro";
import Pagination from "../../../components/Pagination.astro";
import { supabase } from "../../../lib/supabaseClient";
import { getCached, setCached } from "../../../lib/cache";
import { normalizeVendors } from "../../../lib/vendors/vendorUtils";


// Get country from URL param
const countryParam = Astro.params.country || '';

// Normalize country: decode URL, convert hyphens to spaces, trim, and normalize case
// Handles slugs like "united-states" → "united states" → "united states" (lowercase)
function normalizeCountry(country: string): string {
  try {
    const decoded = decodeURIComponent(country).trim();
    // Convert hyphens to spaces for matching (slug format: "united-states" → "united states")
    const withSpaces = decoded.replace(/-/g, ' ');
    return withSpaces.toLowerCase();
  } catch {
    const withSpaces = country.trim().replace(/-/g, ' ');
    return withSpaces.toLowerCase();
  }
}

const normalizedCountry = normalizeCountry(countryParam);

// If no country param, redirect to vendors page
if (!normalizedCountry) {
  return Astro.redirect('/de/vendors');
}

// Get pagination params
const page = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1', 10));
const pageSize = 20;

// Helper function to capitalize first letter of each word (for display)
function capitalizeCountry(country: string): string {
  return country
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// Build cache key
const cacheKey = `vendors:country:de:${countryParam}:${page}`;

// Try to get cached result
interface CachedCountryResult {
  vendors: any[];
  totalVendors: number | null;
}

let cachedResult = getCached<CachedCountryResult>(cacheKey);
let vendors: any[] = [];
let totalVendors: number | null = null;

if (cachedResult) {
  vendors = cachedResult.vendors || [];
  totalVendors = cachedResult.totalVendors;
} else {
  // Build query for vendors filtered by country (case-insensitive using ILIKE)
  function buildCountryQuery() {
    return supabase
      .from('vendors')
      .select(`
        *,
        vendor_categories (
          is_primary,
          categories:categories (
            id,
            slug,
            name_en,
            name_de
          )
        )
      `)
      // Case-insensitive country filter - use ilike for exact match (case-insensitive)
      .ilike('country', normalizedCountry)
      .neq('plan', 'deactivated')
      // Order by featured/priority first (high priority first, nulls last), then alphabetically by name
      .order('priority', { ascending: false, nullsFirst: false })
      .order('name', { ascending: true });
  }

  // Get total count from materialized view
  const { data: countryCount } = await supabase
    .from('country_vendor_counts')
    .select('vendor_count')
    .ilike('country', normalizedCountry)
    .single();
  totalVendors = countryCount?.vendor_count || null;

  // Build paginated query
  const start = (page - 1) * pageSize;
  const end = page * pageSize - 1;
  const paginatedQuery = buildCountryQuery().range(start, end);

  // Execute paginated query
  const { data, error } = await paginatedQuery;

  if (error) {
    console.error('Error fetching vendors:', error);
    vendors = [];
  } else {
    vendors = data || [];
  }

  // Cache the result
  if (totalVendors !== null) {
    setCached(cacheKey, { vendors, totalVendors }, 300);
  }
}

// Normalize category data shape
const normalizedVendors = normalizeVendors(vendors || []);

const totalPages = Math.ceil((totalVendors || 0) / pageSize);

// Get the actual country name from the first vendor (if exists) for proper capitalization
// Otherwise use the normalized param
let displayCountry = normalizedCountry;
if (normalizedVendors.length > 0 && normalizedVendors[0].country) {
  displayCountry = normalizedVendors[0].country;
} else {
  displayCountry = capitalizeCountry(normalizedCountry);
}

// SEO metadata
const CountryName = displayCountry;
const metaTitle = `Automation Companies in ${CountryName} | Automation List`;
const metaDescription = `Discover top industrial automation vendors, PLC experts, SCADA integrators, and system integrators in ${CountryName}.`;
const origin = Astro.url.origin;
const defaultOg = `${origin}/og/default.png`;
const currentUrl = `https://automation-list.com/de/country/${encodeURIComponent(normalizedCountry)}`;

// Build breadcrumbs
const breadcrumbs = [
  { label: "Startseite", href: "/de/" },
  { label: "Anbieter", href: "/de/vendors" },
  { label: CountryName, href: `/de/country/${encodeURIComponent(normalizedCountry)}` },
];

---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
  canonical={currentUrl}
  breadcrumbs={breadcrumbs}
  image={defaultOg}
  lang="de"
>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": `Automation Companies in ${CountryName}`,
    "itemListElement": normalizedVendors.map((v, index) => ({
      "@type": "Organization",
      "position": index + 1,
      "name": v.name,
      "url": `https://automation-list.com/de/vendor/${v.slug}`,
      "logo": v.logo_url,
      "image": v.logo_url,
      "address": v.country
    }))
  })} />
  <div class="container-px mx-auto max-w-7xl px-4 py-10">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">
      Automatisierungsunternehmen in {displayCountry}
    </h1>

    <!-- Result Count -->
    <div class="mb-4">
      <p class="text-sm text-gray-600">
        {totalVendors || 0} {totalVendors === 1 ? 'Anbieter gefunden' : 'Anbieter gefunden'}
        {totalPages > 1 && (
          <span class="text-xs text-gray-500 ml-2">
            (Seite {page} von {totalPages})
          </span>
        )}
      </p>
    </div>

    <!-- Vendor Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {normalizedVendors.length > 0 ? (
        normalizedVendors.map(vendor => (
          <VendorCard
            vendor={vendor}
            hrefPrefix="/de/vendor"
            lang="de"
          />
        ))
      ) : (
        <div class="col-span-full text-center py-12">
          <p class="text-gray-600">
            Keine Anbieter in diesem Land gefunden.
          </p>
        </div>
      )}
    </div>

    <!-- Pagination -->
    <Pagination
      currentPage={page}
      totalPages={totalPages}
      baseUrl={Astro.url}
      lang="de"
    />
  </div>
</BaseLayout>

