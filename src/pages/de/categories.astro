---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CategoryGrid from "../../components/CategoryGrid.astro";
import { supabase } from "../../lib/supabaseClient";


// Fetch active categories from database
const { data: dbCategories } = await supabase
  .from("categories")
  .select("id, slug, name_en, name_de, description_en, description_de, icon_name")
  .eq("is_active", true)
  .order("order_index", { ascending: true });

// Fetch vendor counts from materialized view
const { data: categoryVendorCounts } = await supabase
  .from("category_vendor_counts")
  .select("category_id, vendor_count");

// Create a map of category ID to vendor count
const countMap = new Map<string, number>();
(categoryVendorCounts || []).forEach((item: any) => {
  if (item.category_id) {
    countMap.set(item.category_id, item.vendor_count || 0);
  }
});

// Map database categories with counts from materialized view
const categories = (dbCategories || []).map(cat => ({
  slug: cat.slug || '',
  icon_name: cat.icon_name || '',
  name_en: cat.name_en || '',
  name_de: cat.name_de || '',
  description_en: cat.description_en || '',
  description_de: cat.description_de || '',
  count: cat.id ? (countMap.get(cat.id) || 0) : 0,
})).filter(cat => cat.slug && (cat.name_en || cat.name_de)); // Filter out categories without slug or names

// Generate dynamic description from actual categories
const categoryNames = categories
  .slice(0, 6) // Limit to first 6 categories
  .map(cat => cat.name_de)
  .filter(Boolean);
const description = categoryNames.length > 0
  ? `Durchsuchen Sie Industrieautomatisierungskategorien, einschließlich ${categoryNames.join(', ')}${categoryNames.length < categories.length ? ' und mehr.' : '.'}`
  : "Durchsuchen Sie Industrieautomatisierungskategorien und entdecken Sie Anbieter in Ihrem Fachgebiet.";

// Build breadcrumbs
const breadcrumbs = [
  { label: "Startseite", href: "/de/" },
  { label: "Kategorien", href: "/de/categories" },
];

---

<BaseLayout 
  title="Kategorien für Industrieautomatisierung | Automation List"
  description={description}
  lang="de"
  breadcrumbs={breadcrumbs}
>
  <CategoryGrid title="Kategorien" description={description} categories={categories} lang="de" headingLevel="h1" />
</BaseLayout>

