---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";
import { isFeatured } from "../../lib/isFeatured";
import HowItWorks from "../../components/HowItWorks.astro";
import PageHero from "../../components/PageHero.astro";
import WhyThisDirectory from "../../components/WhyThisDirectory.astro";
import UserBenefits from "../../components/UserBenefits.astro";
import VendorBenefits from "../../components/VendorBenefits.astro";
import SearchForm from "../../components/SearchForm.astro";
import CategoryGrid from "../../components/CategoryGrid.astro";
import FeaturedVendors from "../../components/FeaturedVendors.astro";
import ExploreCTA from "../../components/ExploreCTA.astro";
import { normalizeTech } from "../../lib/normalizeTech";

// German translations
const deNavItems = [
  { label: "Startseite", href: "/de/" },
  { label: "Kategorien", href: "/de/categories" },
  { label: "Anbieter", href: "/de/vendors" },
  { label: "Blog", href: "/de/blog" },
  { label: "Kontakt", href: "/de/contact" },
];

// Fetch featured vendors with vendor_categories
const { data: allVendors } = await supabase
  .from('vendors')
  .select(`
    name, 
    slug, 
    country, 
    technologies,
    vendor_categories (
      is_primary,
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `);

// Normalize category data shape
const normalizedVendors = (allVendors || []).map(v => ({
  ...v,
  category_slugs: v.vendor_categories?.map((vc: any) => vc.categories?.slug).filter(Boolean) || []
}));

// Filter featured vendors
const featured = normalizedVendors.filter(v => isFeatured(v));

// Sort featured vendors by priority ASC
featured.sort((a, b) => (a.priority || 999) - (b.priority || 999));

// Limit to 6 vendors
let featuredVendors = featured.slice(0, 6);

// Fallback logic: if no featured vendors, use 6 random vendors (but don't mark as featured)
if (featuredVendors.length === 0 && normalizedVendors.length > 0) {
  featuredVendors = [...normalizedVendors].sort(() => Math.random() - 0.5).slice(0, 6);
}

// Helper function to format technologies for display
function formatTechnologies(technologies: string | null): string {
  if (!technologies) return '';
  const techArray = technologies.split(',').map(t => t.trim());
  return techArray.slice(0, 3).join(', ') + (techArray.length > 3 ? '...' : '');
}

// Fetch active categories from database
const { data: dbCategories } = await supabase
  .from("categories")
  .select("id, slug, name_en, name_de, description_en, description_de, icon_name")
  .eq("is_active", true)
  .order("order_index", { ascending: true });

// Helper function to count vendors by category slug
function countByCategorySlug(categorySlug: string): number {
  if (!normalizedVendors) return 0;
  return normalizedVendors.filter(v => 
    v.category_slugs.includes(categorySlug)
  ).length;
}

// Map database categories with counts
const categories = (dbCategories || []).map(cat => ({
  slug: cat.slug || '',
  icon_name: cat.icon_name || '',
  name_en: cat.name_en || '',
  name_de: cat.name_de || '',
  description_en: cat.description_en || '',
  description_de: cat.description_de || '',
  count: countByCategorySlug(cat.slug || ''),
})).filter(cat => cat.slug && (cat.name_en || cat.name_de)); // Filter out categories without slug or names

// Extract and count technologies from vendors
const technologyFrequency = new Map<string, number>();
(normalizedVendors || []).forEach((vendor: any) => {
  if (vendor.technologies && typeof vendor.technologies === 'string') {
    const techs = vendor.technologies
      .split(',')
      .map((tech: string) => tech.trim())
      .filter((tech: string) => tech.length > 0);
    techs.forEach((tech: string) => {
      const normalized = tech.toLowerCase().trim();
      if (normalized) {
        technologyFrequency.set(normalized, (technologyFrequency.get(normalized) || 0) + 1);
      }
    });
  }
});

// Sort by frequency (descending) and get top 8
const popularTechnologies = Array.from(technologyFrequency.entries())
  .map(([name, count]) => ({ name, count, slug: normalizeTech(name) }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 8);
---

<BaseLayout 
  title="Automation List - Demnächst verfügbar"
  description="Entdecken Sie die besten Automatisierungstools und Workflows für Ihre Produktivitätsbedürfnisse."
  lang="de"
  navItems={deNavItems}
>
  <PageHero
    title="Finden Sie die besten Industrieautomatisierungsanbieter weltweit"
    description="Vergleichen Sie Systemintegratoren, OEMs, Robotikexperten, MES/SCADA-Spezialisten und industrielle IT-Anbieter — anbieterneutral und von Automatisierungsingenieuren erstellt."
    primaryButtonText="Verzeichnis durchsuchen →"
    primaryButtonHref="/de/vendors"
  />

  <SearchForm 
    title="Verzeichnis durchsuchen"
    action="/de/vendors"
    placeholder="Anbieter, Technologien oder Kategorien suchen..."
    buttonText="Suchen"
  />

  <CategoryGrid 
    title="Nach Kategorie durchsuchen"
    categories={categories}
    lang="de"
  />

  <!-- Popular Technologies Section -->
  {popularTechnologies.length > 0 && (
    <section class="container-px mx-auto max-w-7xl px-4 py-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Beliebte Technologien</h2>
      <div class="flex flex-wrap justify-center gap-3">
        {popularTechnologies.map((tech) => (
          <a
            href={`/de/technology/${tech.slug}`}
            class="text-sm text-gray-700 hover:text-brand-600 hover:underline transition-colors px-3 py-1"
          >
            {tech.name} ({tech.count})
          </a>
        ))}
      </div>
    </section>
  )}

  <FeaturedVendors
    title="Ausgewählte Anbieter"
    vendors={featuredVendors}
    viewAllHref="/de/vendors"
    viewAllText="Alle Anbieter anzeigen →"
    vendorHrefPrefix="/de/vendor"
    vendorLinkText="Profil anzeigen →"
    formatTechnologies={formatTechnologies}
    isFeatured={isFeatured}
  />

  <WhyThisDirectory
    title="Warum dieses Verzeichnis?"
    description="Automation-List ist ein anbieterneutrales Verzeichnis, das von Automatisierungsingenieuren erstellt wurde. Keine gesponserten Rankings, keine Agenturen, die Ergebnisse manipulieren — nur saubere, strukturierte Daten."
    benefits={[
      "Anbieterneutral und unvoreingenommen",
      "Erstellt von Automatisierungsfachleuten",
      "Klare Kategorien und Technologiezuordnung",
      "Globale Abdeckung",
      "Ständige Weiterentwicklung",
    ]}
  />

  <HowItWorks 
    title="So funktioniert's"
    steps={[
      {
        title: "1. Suchen",
        description: "Finden Sie Anbieter nach Kategorie, Technologie oder Land.",
      },
      {
        title: "2. Vergleichen",
        description: "Prüfen Sie Profile, Fähigkeiten und Technologien.",
      },
      {
        title: "3. Kontaktieren",
        description: "Kontaktieren Sie direkt — ohne Zwischenhändler.",
      },
    ]}
  />

  <UserBenefits 
    title="Vorteile für Nutzer"
    benefits={[
      "Vertrauenswürdige Integratoren schneller finden",
      "Transparente Anbieterprofile",
      "Nach Technologien und Standort filtern",
      "Verifizierte Geschäftsdaten",
    ]}
  />

  <VendorBenefits 
    title="Vorteile für Anbieter"
    benefits={[
      "Sichtbarkeit erhöhen",
      "SEO-optimiertes Profil",
      "Neutrale Plattform (keine bezahlten Rankings)",
      "Hersteller und Integratoren erreichen",
      "Optionale Premium-Platzierungen (demnächst)",
    ]}
    ctaText="Ihr Unternehmen hinzufügen →"
    ctaHref="/de/contact"
  />

  <ExploreCTA 
    title="Bereit, Automatisierungsanbieter zu erkunden?"
    description="Finden Sie vertrauenswürdige Integratoren und Automatisierungspartner weltweit."
    primaryButtonText="Verzeichnis durchsuchen →"
    primaryButtonHref="/de/vendors"
  />
</BaseLayout>

