---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";
import { isFeatured } from "../../lib/isFeatured";
import HowItWorks from "../../components/HowItWorks.astro";
import PageHero from "../../components/PageHero.astro";
import WhyThisDirectory from "../../components/WhyThisDirectory.astro";
import UserBenefits from "../../components/UserBenefits.astro";
import VendorBenefits from "../../components/VendorBenefits.astro";
import SearchForm from "../../components/SearchForm.astro";
import CategoryGrid from "../../components/CategoryGrid.astro";
import IndustryGrid from "../../components/IndustryGrid.astro";
import FeaturedVendors from "../../components/FeaturedVendors.astro";
import ExploreCTA from "../../components/ExploreCTA.astro";
import { getIndustries } from "../../lib/getIndustries";
import { normalizeVendors } from "../../lib/vendors/vendorUtils";
import type { VendorWithRelations } from "../../types/vendor";


// Fetch ONLY featured vendors: plan='pro' OR (featured=true AND featured_until>now)
// Use two queries to handle the complex condition, then combine and limit to 6
const now = new Date().toISOString();

// Query 1: Get pro plan vendors (limit 6, ordered by priority)
const { data: proVendors } = await supabase
  .from("vendors")
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        name_en,
        name_de
      )
    ),
    vendor_technologies (
      technologies:technologies (
        name_en,
        name_de
      )
    )
  `)
  .eq('plan', 'pro')
  .order('priority', { ascending: true, nullsFirst: false })
  .limit(6);

// Query 2: Get featured vendors with valid featured_until date (limit 6, ordered by priority)
const { data: featuredVendorsData } = await supabase
  .from("vendors")
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        name_en,
        name_de
      )
    ),
    vendor_technologies (
      technologies:technologies (
        name_en,
        name_de
      )
    )
  `)
  .eq('featured', true)
  .gt('featured_until', now)
  .neq('plan', 'deactivated')
  .order('priority', { ascending: true, nullsFirst: false })
  .limit(6);

// Combine and deduplicate by id
const vendorMap = new Map();
[...(proVendors || []), ...(featuredVendorsData || [])].forEach(v => {
  if (!vendorMap.has(v.id)) {
    vendorMap.set(v.id, v);
  }
});
const vendors = Array.from(vendorMap.values());

// Normalize category data shape
const normalizedVendors = normalizeVendors(vendors);

// No need to filter with isFeatured - queries already fetch only valid featured vendors:
// - plan='pro' vendors (all pro vendors are featured)
// - featured=true AND featured_until > now (only valid featured vendors)
// Sort by priority ASC
normalizedVendors.sort((a, b) => (a.priority || 999) - (b.priority || 999));

// Limit to 6 vendors
let featuredVendors = normalizedVendors.slice(0, 6);

// Fallback logic: if no featured vendors, use 6 random vendors (but don't mark as featured)
// Note: This fallback may not be needed if query works correctly, but kept for safety
if (featuredVendors.length === 0) {
  const { data: fallbackVendors } = await supabase
    .from("vendors")
    .select(`
      *,
      vendor_categories (
        is_primary,
        categories:categories (
          id,
          slug,
          name_en,
          name_de
        )
      ),
      vendor_technologies (
        technologies:technologies (
          id,
          slug,
          name_en,
          name_de
        )
      )
    `)
    .neq('plan', 'deactivated')
    .limit(6);
  
  const normalizedFallback = normalizeVendors(fallbackVendors || []);
  featuredVendors = [...normalizedFallback].sort(() => Math.random() - 0.5).slice(0, 6);
}

// Helper function to format technologies for display (first 2 only)
function formatTechnologies(vendor: VendorWithRelations): string {
  if (!vendor.vendor_technologies || vendor.vendor_technologies.length === 0) return '';
  const techNames = vendor.vendor_technologies
    .map((vt: any) => vt.technologies?.name_de || vt.technologies?.name_en)
    .filter(Boolean)
    .slice(0, 2);
  return techNames.join(', ') + (vendor.vendor_technologies.length > 2 ? '...' : '');
}

// Helper function to truncate description
function truncateDescription(text: string | null | undefined, maxLength: number = 120): string {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '…';
}

// Fetch active categories from database
const { data: dbCategories } = await supabase
  .from("categories")
  .select("id, slug, name_en, name_de, description_en, description_de, icon_name")
  .eq("is_active", true)
  .order("order_index", { ascending: true });

// Fetch vendor counts from materialized view
const { data: categoryVendorCounts } = await supabase
  .from("category_vendor_counts")
  .select("category_id, vendor_count");

// Create a map of category ID to vendor count
const categoryCountMap = new Map<string, number>();
(categoryVendorCounts || []).forEach((item: any) => {
  if (item.category_id) {
    categoryCountMap.set(item.category_id, item.vendor_count || 0);
  }
});

// Map database categories with counts from materialized view
const categories = (dbCategories || []).map(cat => ({
  slug: cat.slug || '',
  icon_name: cat.icon_name || '',
  name_en: cat.name_en || '',
  name_de: cat.name_de || '',
  description_en: cat.description_en || '',
  description_de: cat.description_de || '',
  count: cat.id ? (categoryCountMap.get(cat.id) || 0) : 0,
})).filter(cat => cat.slug && (cat.name_en || cat.name_de)); // Filter out categories without slug or names

// Fetch active industries (limit 8-12, ordered by order_index then name)
const allIndustries = await getIndustries({ lang: "de", activeOnly: true });
const industries = allIndustries.slice(0, 12);

// Build WebSite structured data with SearchAction
const origin = Astro.url.origin;
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": `${origin}/de/`,
  "name": "Automation List",
  "description": "Entdecken Sie die besten Automatisierungstools und Workflows für Ihre Produktivitätsbedürfnisse.",
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${origin}/de/vendors?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  }
};

const websiteSchemaJson = JSON.stringify(websiteSchema);

---

<BaseLayout 
  title="Automation List"
  description="Entdecken Sie die besten Automatisierungstools und Workflows für Ihre Produktivitätsbedürfnisse."
  lang="de"
>
  <script slot="head" type="application/ld+json" set:html={websiteSchemaJson} />
  <PageHero
    title="Anbieter für Industrieautomatisierung finden"
    description="Vergleichen Sie Systemintegratoren, OEMs und Automatisierungsexperten – anbieterneutral und von Automatisierungsingenieuren erstellt."
    primaryButtonText="Verzeichnis durchsuchen →"
    primaryButtonHref="/de/vendors"
    secondaryButtonText="Unternehmen kostenlos eintragen →"
    secondaryButtonHref="/de/contact"
    secondaryMicroCopy="Kostenlos während der MVP-Phase"
  />

  <SearchForm 
    title="Verzeichnis durchsuchen"
    action="/de/vendors"
    placeholder="Anbieter, Technologien oder Kategorien suchen..."
    buttonText="Suchen"
  />

  <CategoryGrid 
    title="Nach Kategorie durchsuchen"
    categories={categories}
    lang="de"
  />

  <IndustryGrid 
    title="Nach Branche"
    industries={industries}
    lang="de"
  />

  <FeaturedVendors
    title="Ausgewählte Anbieter"
    vendors={featuredVendors}
    viewAllHref="/de/vendors"
    viewAllText="Alle Anbieter anzeigen →"
    vendorHrefPrefix="/de/vendor"
    vendorLinkText="Profil anzeigen →"
    formatTechnologies={formatTechnologies}
    truncateDescription={truncateDescription}
    isFeatured={isFeatured}
  />

  <WhyThisDirectory
    title="Warum dieses Verzeichnis?"
    description="Automation-List ist ein anbieterneutrales Verzeichnis, das von Automatisierungsingenieuren erstellt wurde. Keine gesponserten Rankings, keine Agenturen, die Ergebnisse manipulieren — nur saubere, strukturierte Daten."
    benefits={[
      "Anbieterneutral und unvoreingenommen",
      "Erstellt von Automatisierungsfachleuten",
      "Klare Kategorien und Technologiezuordnung",
      "Globale Abdeckung",
      "Ständige Weiterentwicklung",
    ]}
  />

  <HowItWorks 
    title="So funktioniert's"
    steps={[
      {
        title: "1. Suchen",
        description: "Finden Sie Anbieter nach Kategorie, Technologie oder Land.",
      },
      {
        title: "2. Vergleichen",
        description: "Prüfen Sie Profile, Fähigkeiten und Technologien.",
      },
      {
        title: "3. Kontaktieren",
        description: "Kontaktieren Sie direkt — ohne Zwischenhändler.",
      },
    ]}
  />

  <UserBenefits 
    title="Vorteile für Nutzer"
    benefits={[
      "Vertrauenswürdige Integratoren schneller finden",
      "Transparente Anbieterprofile",
      "Nach Technologien und Standort filtern",
      "Verifizierte Geschäftsdaten",
    ]}
  />

  <VendorBenefits 
    title="Vorteile für Anbieter"
    benefits={[
      "Sichtbarkeit erhöhen",
      "SEO-optimiertes Profil",
      "Neutrale Plattform (keine bezahlten Rankings)",
      "Hersteller und Integratoren erreichen",
      "Optionale Premium-Platzierungen (demnächst)",
    ]}
    ctaText="Ihr Unternehmen kostenlos eintragen →"
    ctaHref="/de/contact"
    microCopy="Kostenlos während der MVP-Phase"
  />

  <ExploreCTA 
    title="Bereit, Automatisierungsanbieter zu erkunden?"
    description="Finden Sie vertrauenswürdige Integratoren und Automatisierungspartner weltweit."
    primaryButtonText="Verzeichnis durchsuchen →"
    primaryButtonHref="/de/vendors"
  />
</BaseLayout>

