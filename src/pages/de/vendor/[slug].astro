---
// Server-Side Rendering (SSR) - This page is rendered on-demand
// See STATIC_GENERATION_STRATEGY.md for details

export const prerender = false;

import { supabase } from '../../../lib/supabaseClient';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import LogoBox from '../../../components/LogoBox.astro';
import { normalizeVendor } from '../../../lib/vendors/vendorUtils';

// Helper function to parse logo background variant from logo URL
// Supports pattern: __{variant}.{ext} (e.g., logo__dark.svg)
// Also checks for common patterns in filename (e.g., logo_white.svg -> dark background)
function parseLogoVariant(logoUrl: string | null | undefined): "light" | "dark" | "neutral" | "brand" {
  if (!logoUrl) return "light";
  
  const url = logoUrl.toLowerCase();
  
  // Check for explicit variant pattern: __{variant}.{ext}
  const explicitVariantMatch = url.match(/__([a-z]+)\.(svg|png|jpg|jpeg|webp)$/);
  if (explicitVariantMatch) {
    const variant = explicitVariantMatch[1];
    const variantMap: Record<string, "light" | "dark" | "neutral" | "brand"> = {
      white: 'light',
      light: 'neutral',
      gray: 'neutral',
      dark: 'dark',
      brand: 'brand',
    };
    if (variantMap[variant]) {
      return variantMap[variant];
    }
  }
  
  // Check for common filename patterns
  // If filename contains "white", use dark background (white logo on dark bg)
  if (url.includes('_white') || url.includes('-white') || url.match(/white[._-]/)) {
    return 'dark';
  }
  
  // If filename contains "dark" or "black", use light background
  if (url.includes('_dark') || url.includes('-dark') || url.includes('_black') || url.includes('-black')) {
    return 'light';
  }
  
  // Default to light background
  return 'light';
}

// Fetch full vendor data by slug with vendor_categories JOIN
const { slug } = Astro.params;

const { data: vendor, error } = await supabase
  .from('vendors')
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    ),
    vendor_technologies (
      technologies:technologies (
        id,
        slug,
        name_en,
        name_de
      )
    ),
    vendor_industries (
      industries:industries (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `)
  .eq('slug', slug)
  .maybeSingle();

if (error) {
  console.error('Error fetching vendor:', error);
}

if (!vendor) {
  return Astro.redirect('/de/vendors');
}

// Normalize category, technology, and industry data shape
const normalizedVendor = normalizeVendor(vendor, {
  includeCategories: true,
  includeTechnologies: false,
  includeIndustries: false
});
// Use language-specific description (DE: description_de, fallback to description_en if missing)
normalizedVendor.description_en = vendor.description_en || null;
normalizedVendor.description_de = vendor.description_de || null;
// Keep technologies and industries as arrays with slug and name for linking
normalizedVendor.vendor_technologies = vendor.vendor_technologies || [];
normalizedVendor.vendor_industries = vendor.vendor_industries || [];

const deNavItems = [
  { label: "Startseite", href: "/de/" },
  { label: "Kategorien", href: "/de/categories" },
  { label: "Technologien", href: "/de/technologies" },
  { label: "Anbieter", href: "/de/vendors" },
  { label: "Blog", href: "/de/blog" },
  { label: "Kontakt", href: "/de/contact" },
];

const backUrl = "/de/vendors";

// Helper function to split comma-separated values into array
function splitValue(value: string | string[] | null | undefined): string[] {
  if (!value) return [];
  if (Array.isArray(value)) return value;
  return String(value).split(',').map(item => item.trim()).filter(Boolean);
}

// Helper function to format array or string values for display
function formatValue(value: string | string[] | null | undefined): string {
  if (!value) return '';
  if (Array.isArray(value)) {
    return value.join(', ');
  }
  return String(value);
}

// Helper function to truncate description
function truncateDescription(text: string | null | undefined, maxLength: number = 300): string {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

// Determine plan status
const plan = normalizedVendor.plan || 'free';
const isFeatured = normalizedVendor.featured === true || plan === 'featured';
const isPro = plan === 'pro' || isFeatured;
const isFree = plan === 'free' && !isFeatured;
const isOgMember = normalizedVendor.og_member === true;

// Build location string
function getLocation(): string {
  const parts: string[] = [];
  if (normalizedVendor.city) parts.push(normalizedVendor.city);
  if (normalizedVendor.region) parts.push(normalizedVendor.region);
  if (normalizedVendor.country) parts.push(normalizedVendor.country);
  return parts.join(', ');
}

const location = getLocation();

// Get primary category
const primaryCategory = normalizedVendor.vendor_categories?.find((vc: any) => vc.is_primary === true);
const primaryCategoryName = primaryCategory?.categories?.name_de || primaryCategory?.categories?.name_en;
const primaryCategorySlug = primaryCategory?.categories?.slug;

// Determine canonical URL
const canonicalUrl = normalizedVendor.canonical_url || `https://automation-list.com/de/vendor/${slug}`;

// Build JSON-LD Organization schema
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: normalizedVendor.name,
  ...(normalizedVendor.website && { url: normalizedVendor.website }),
  ...(normalizedVendor.logo_url && { logo: normalizedVendor.logo_url }),
  ...((normalizedVendor.description_de || normalizedVendor.description_en) && { 
    description: normalizedVendor.description_de || normalizedVendor.description_en 
  }),
  ...((normalizedVendor.city || normalizedVendor.country) && {
    address: {
      "@type": "PostalAddress",
      ...(normalizedVendor.city && { addressLocality: normalizedVendor.city }),
      ...(normalizedVendor.country && { addressCountry: normalizedVendor.country }),
    },
  }),
  ...(normalizedVendor.website && { sameAs: [normalizedVendor.website] }),
};

const organizationSchemaJson = JSON.stringify(organizationSchema);

// Build JSON-LD BreadcrumbList schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Startseite",
      item: `${Astro.url.origin}/de/`,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Anbieter",
      item: `${Astro.url.origin}/de/vendors`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: normalizedVendor.name,
      item: `${Astro.url.origin}/de/vendor/${slug}`,
    },
  ],
};

const breadcrumbSchemaJson = JSON.stringify(breadcrumbSchema);

// Determine title: use meta_title if available, otherwise fallback to vendor.name + " | Automation List"
const pageTitle = normalizedVendor.meta_title || `${normalizedVendor.name} | Automation List`;

// Determine description: use meta_description if available, otherwise fallback to truncated vendor.description_de (or description_en)
const pageDescription = normalizedVendor.meta_description || 
  ((normalizedVendor.description_de || normalizedVendor.description_en) ? truncateDescription(normalizedVendor.description_de || normalizedVendor.description_en, 160) : `Erfahren Sie mehr über ${normalizedVendor.name}, einen führenden Anbieter in der Industrieautomatisierung.`);

// Determine OG image: use vendor.logo_url if available, otherwise fallback to default
const origin = Astro.url.origin;
const image = normalizedVendor.logo_url || `${origin}/og/default.png`;

// Prepare technologies data (Pro Members only)
const technologiesToShow = isPro && normalizedVendor.vendor_technologies && normalizedVendor.vendor_technologies.length > 0
  ? normalizedVendor.vendor_technologies
  : [];

// Prepare certifications data
const certifications = isPro && normalizedVendor.certifications ? splitValue(normalizedVendor.certifications) : [];

// Prepare languages data
const languages = isPro && normalizedVendor.languages ? splitValue(normalizedVendor.languages) : [];

// Prepare industries data (Pro Members only)
const industries = isPro && normalizedVendor.vendor_industries ? normalizedVendor.vendor_industries : [];

// Prepare tags data
const tags = isPro && normalizedVendor.tags ? splitValue(normalizedVendor.tags) : [];

// Prepare categories data (show everywhere, not just for Pro)
const allCategories = normalizedVendor.vendor_categories || [];
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  ogImage={image}
  lang="de"
  navItems={deNavItems}
  meta={{ canonical: canonicalUrl }}
>
  <script slot="head" type="application/ld+json" set:html={organizationSchemaJson} />
  <script slot="head" type="application/ld+json" set:html={breadcrumbSchemaJson} />
  <div class="container-px mx-auto max-w-4xl px-4 py-10">
    <a href={backUrl} class="text-sm text-brand-700 hover:text-brand-800 mb-6 inline-block">
      ← Zurück zu Anbietern
    </a>

    <!-- SECTION 1 — HEADER -->
    <div class={`mb-8 text-center ${isFeatured ? 'border-2 border-orange-300 rounded-lg p-6 bg-orange-50/30' : ''}`}>
      <div class="flex justify-center mb-4">
        <LogoBox 
          src={normalizedVendor.logo_url} 
          alt={normalizedVendor.logo_alt || `${normalizedVendor.name} Logo`}
          size="md"
          variant={parseLogoVariant(normalizedVendor.logo_url)}
          logoWidth={normalizedVendor.logo_width}
          logoHeight={normalizedVendor.logo_height}
        />
      </div>
      
      <h1 class="text-3xl font-bold text-gray-900 mb-3">{normalizedVendor.name}</h1>
      
      <!-- Badges -->
      <div class="flex flex-wrap justify-center gap-2 mb-4">
        {isFeatured && (
          <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700">
            Featured Vendor
          </span>
        )}
        {isPro && !isFeatured && (
          <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
            Pro
          </span>
        )}
        {isOgMember && (
          <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
            OG Member — Preis für immer gesperrt
          </span>
        )}
      </div>

      <!-- Primary Category -->
      {primaryCategoryName && primaryCategorySlug && (
        <p class="text-sm text-gray-600 mb-2">
          <a 
            href={`/de/category/${primaryCategorySlug}`}
            class="inline-block px-2 py-1 text-xs font-medium bg-brand-50 text-brand-700 rounded hover:bg-brand-100 transition-colors"
          >
            {primaryCategoryName}
          </a>
        </p>
      )}

      {location && (
        <p class="text-sm text-gray-600 mb-4">{location}</p>
      )}

      {normalizedVendor.website && (
        <a 
          href={normalizedVendor.website} 
          target="_blank" 
          rel="noopener noreferrer"
          class="inline-block px-4 py-2 bg-black text-white rounded-md text-sm font-medium hover:bg-gray-900 transition"
        >
          Website besuchen →
        </a>
      )}
    </div>

    <!-- SECTION 2 — DESCRIPTION -->
    {(normalizedVendor.description_de || normalizedVendor.description_en) && (
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Über</h2>
        <p class="text-gray-700 text-sm leading-relaxed">
          {isFree ? truncateDescription(normalizedVendor.description_de || normalizedVendor.description_en, 300) : (normalizedVendor.description_de || normalizedVendor.description_en)}
        </p>
        {isFree && (
          <p class="text-sm text-gray-500 italic mt-3 p-3 bg-gray-50 rounded border border-gray-200">
            Dies ist eine kostenlose Anbieterliste. Upgraden Sie auf Pro, um das vollständige Profil freizuschalten.
          </p>
        )}
      </div>
    )}

    <!-- SECTION 3 — GRID BLOCKS -->
    {(technologiesToShow.length > 0 || certifications.length > 0 || languages.length > 0 || industries.length > 0 || tags.length > 0 || allCategories.length > 0) && (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Technologies -->
        {technologiesToShow.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Technologien</h3>
            <div class="flex flex-wrap gap-2">
              {technologiesToShow.map((vt: any) => {
                const tech = vt.technologies;
                const techName = tech?.name_de || tech?.name_en;
                const techSlug = tech?.slug;
                if (!techName || !techSlug) return null;
                return (
                  <a 
                    href={`/de/technology/${techSlug}`}
                    class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                  >
                    {techName}
                  </a>
                );
              })}
            </div>
          </div>
        )}

        <!-- Certifications -->
        {certifications.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Zertifizierungen</h3>
            <div class="flex flex-wrap gap-2">
              {certifications.map((cert) => (
                <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                  {cert}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Languages -->
        {languages.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Sprachen</h3>
            <div class="flex flex-wrap gap-2">
              {languages.map((lang) => (
                <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                  {lang}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Industries -->
        {industries.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Branchen</h3>
            <div class="flex flex-wrap gap-2">
              {industries.map((vi: any) => {
                const industry = vi.industries;
                const industryName = industry?.name_de || industry?.name_en;
                const industrySlug = industry?.slug;
                if (!industryName || !industrySlug) return null;
                return (
                  <a 
                    href={`/de/industry/${industrySlug}`}
                    class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                  >
                    {industryName}
                  </a>
                );
              })}
            </div>
          </div>
        )}

        <!-- Tags -->
        {tags.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Categories -->
        {allCategories.length > 0 && (
          <div class="border border-gray-200 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Kategorien</h3>
            <div class="flex flex-wrap gap-2">
              {allCategories.map((vc: any) => {
                const categoryName = vc.categories?.name_de || vc.categories?.name_en;
                const categorySlug = vc.categories?.slug;
                if (!categoryName || !categorySlug) return null;
                return (
                  <a 
                    href={`/de/category/${categorySlug}`}
                    class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                  >
                    {categoryName}
                  </a>
                );
              })}
            </div>
          </div>
        )}
      </div>
    )}

    <!-- SECTION 4 — COMPANY FACTS (pro/featured only) -->
    {isPro && (normalizedVendor.year_founded || normalizedVendor.employee_count || normalizedVendor.hourly_rate || normalizedVendor.region || normalizedVendor.country) && (
      <div class="border border-gray-200 rounded-lg p-6 mb-8 bg-gray-50">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Unternehmensfakten</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {normalizedVendor.year_founded && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Gründungsjahr</p>
              <p class="text-sm font-medium text-gray-900">{normalizedVendor.year_founded}</p>
            </div>
          )}
          {normalizedVendor.employee_count && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Mitarbeiter</p>
              <p class="text-sm font-medium text-gray-900">{normalizedVendor.employee_count}</p>
            </div>
          )}
          {normalizedVendor.hourly_rate && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Stundensatz</p>
              <p class="text-sm font-medium text-gray-900">{normalizedVendor.hourly_rate}</p>
            </div>
          )}
          {(normalizedVendor.region || normalizedVendor.country) && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Standort</p>
              <p class="text-sm font-medium text-gray-900">{location}</p>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- SECTION 5 — CONTACT CARD (pro/featured only) -->
    {isPro && (normalizedVendor.email || normalizedVendor.phone || normalizedVendor.address) && (
      <div class="border border-gray-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Kontakt</h2>
        <div class="space-y-3">
          {normalizedVendor.email && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">E-Mail</p>
              <a href={`mailto:${normalizedVendor.email}`} class="text-sm text-brand-700 hover:text-brand-800">
                {normalizedVendor.email}
              </a>
            </div>
          )}
          {normalizedVendor.phone && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Telefon</p>
              <a href={`tel:${normalizedVendor.phone}`} class="text-sm text-brand-700 hover:text-brand-800">
                {normalizedVendor.phone}
              </a>
            </div>
          )}
          {normalizedVendor.address && (
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Adresse</p>
              <p class="text-sm text-gray-900">{normalizedVendor.address}</p>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- SECTION 6 — UPGRADE CTA (free only) -->
    {isFree && (
      <div class="border-2 border-orange-200 rounded-lg p-6 bg-orange-50 text-center">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Vollständiges Profil freischalten?</h3>
        <p class="text-sm text-gray-600 mb-4">
          Kontaktieren Sie uns, um auf Pro zu upgraden und Ihr vollständiges Anbieterprofil zu präsentieren.
        </p>
        <a 
          href="/de/contact" 
          class="inline-block px-6 py-2 bg-orange-600 text-white rounded-md text-sm font-medium hover:bg-orange-700 transition"
        >
          Kontaktieren Sie uns für ein Upgrade
        </a>
      </div>
    )}
  </div>
</BaseLayout>
