---
import { supabase } from '../../lib/supabaseClient';
import VendorCard from '../VendorCard.astro';

interface Props {
  lang: "en" | "de";
  pageTitle: string;
}

const { lang, pageTitle } = Astro.props;

// Parse URL parameters (decode URL-encoded values safely)
function safeDecode(param: string | null): string {
  if (!param) return '';
  try {
    return decodeURIComponent(param).trim();
  } catch {
    return param.trim();
  }
}

const searchQuery = safeDecode(Astro.url.searchParams.get('q'));
const countryFilter = safeDecode(Astro.url.searchParams.get('country'));
const activeCategory = safeDecode(Astro.url.searchParams.get('category'));

// Fetch all categories from database for the dropdown
const { data: dbCategories } = await supabase
  .from('categories')
  .select('id, slug, name_en, name_de')
  .order('name_en', { ascending: true });

// Build Supabase query with vendor_categories JOIN
let query = supabase
  .from('vendors')
  .select(`
    *,
    vendor_categories (
      is_primary,
      categories:categories (
        id,
        slug,
        name_en,
        name_de
      )
    )
  `);

// Apply search filter if present (filter by vendor name)
if (searchQuery) {
  query = query.ilike('name', `%${searchQuery}%`);
}

// Apply country filter if present
if (countryFilter) {
  query = query.eq('country', countryFilter);
}

// Sort by priority (high priority first, nulls last), then by name ascending
query = query.order('priority', { ascending: false, nullsLast: true })
  .order('name', { ascending: true });

// Execute query
const { data: vendors, error } = await query;

if (error) {
  console.error('Error fetching vendors:', error);
}

// Initialize filtered vendors
let filteredVendors = vendors || [];

// Apply category filter in JavaScript (Supabase doesn't support filtering on nested relationships)
if (activeCategory) {
  filteredVendors = filteredVendors.filter(vendor => 
    (vendor.vendor_categories || []).some((vc: any) => vc.categories?.slug === activeCategory)
  );
}

// Extract unique lists for filter dropdowns from ALL vendors (not filtered) for dropdown options
const uniqueCountryList = Array.from(
  new Set((vendors || []).map(v => v.country).filter(Boolean))
).sort();

// Build category list with slugs from database categories
const categoryList = (dbCategories || []).map(cat => ({
  slug: cat.slug,
  name: lang === "de" ? (cat.name_de || cat.name_en) : (cat.name_en || cat.name_de)
})).filter(cat => cat.slug && cat.name);
---

<div class="container-px mx-auto max-w-7xl px-4 py-10">
  <h1 class="text-3xl font-bold text-gray-900 mb-8">{pageTitle}</h1>

  <!-- Search and Filter Form -->
  <div class="border border-gray-200 rounded-lg p-4 mb-8 bg-white shadow-sm">
    <form method="GET" action={Astro.url.pathname}>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Search Bar -->
        <div>
          <input
            type="text"
            name="q"
            value={searchQuery}
            placeholder={lang === "de" ? "Suchen..." : "Search..."}
            class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm"
          />
        </div>

        <!-- Country Filter -->
        <div>
          <select
            name="country"
            class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm"
          >
            <option value="">{lang === "de" ? "Alle Länder" : "All Countries"}</option>
            {uniqueCountryList.map(country => (
              <option value={country} selected={country === countryFilter}>
                {country}
              </option>
            ))}
          </select>
        </div>

        <!-- Category Filter -->
        <div>
          <select
            name="category"
            class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm"
          >
            <option value="">{lang === "de" ? "Alle Kategorien" : "All Categories"}</option>
            {categoryList.map(cat => (
              <option value={cat.slug} selected={activeCategory === cat.slug}>
                {cat.name}
              </option>
            ))}
          </select>
        </div>
      </div>

      <!-- Filter Buttons -->
      <div class="mt-4 flex gap-3">
        <button
          type="submit"
          class="bg-brand-600 text-white px-4 py-2 rounded-md hover:bg-brand-700 text-sm font-medium"
        >
          {lang === "de" ? "Filtern" : "Filter"}
        </button>
        {(searchQuery || countryFilter || activeCategory) && (
          <a
            href={Astro.url.pathname}
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium"
          >
            {lang === "de" ? "Zurücksetzen" : "Clear"}
          </a>
        )}
      </div>
    </form>
  </div>

  <!-- Result Count -->
  <div class="mb-4">
    <p class="text-sm text-gray-600">
      {filteredVendors.length} {lang === "de" ? "Anbieter gefunden" : "vendors found"}
      {(searchQuery || countryFilter || activeCategory) && (
        <span class="text-xs text-gray-500 ml-2">
          ({lang === "de" ? "gefiltert" : "filtered"})
        </span>
      )}
    </p>
    {(searchQuery || countryFilter || activeCategory) && (
      <div class="mt-2 flex flex-wrap gap-2">
        {searchQuery && (
          <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
            {lang === "de" ? "Suche" : "Search"}: "{searchQuery}"
          </span>
        )}
        {countryFilter && (
          <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-800">
            {lang === "de" ? "Land" : "Country"}: {countryFilter}
          </span>
        )}
        {activeCategory && (
          <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 text-purple-800">
            {lang === "de" ? "Kategorie" : "Category"}: {activeCategory}
          </span>
        )}
      </div>
    )}
  </div>

  <!-- Vendor Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {filteredVendors.length > 0 ? (
      filteredVendors.map(vendor => (
        <VendorCard
          vendor={vendor}
          hrefPrefix={`/${lang}/vendor`}
          lang={lang}
        />
      ))
    ) : (
      <div class="col-span-full text-center py-12">
        <p class="text-gray-600">
          {lang === "de" ? "Keine Anbieter gefunden." : "No vendors found."}
        </p>
      </div>
    )}
  </div>
</div>

