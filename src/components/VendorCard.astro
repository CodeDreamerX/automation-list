---
import { isFeatured } from '../lib/isFeatured';

interface Vendor {
  name: string;
  slug: string;
  country?: string | null;
  region?: string | null;
  technologies?: string | null;
  description?: string | null;
  description_en?: string | null;
  description_de?: string | null;
  logo_url?: string | null;
  logo_width?: number | null;
  logo_height?: number | null;
  logo_alt?: string | null;
  priority?: number | null;
  featured?: boolean | null;
  category_slugs?: string[];
  vendor_categories?: Array<{
    is_primary?: boolean | null;
    categories?: {
      id: string;
      slug: string;
      name_en?: string | null;
      name_de?: string | null;
    } | null;
  }> | null;
}

interface Props {
  vendor: Vendor;
  hrefPrefix?: string;
  showFeaturedBadge?: boolean;
  compact?: boolean;
  lang?: "en" | "de";
}

const {
  vendor,
  hrefPrefix = "/en/vendor",
  showFeaturedBadge = true,
  compact = false,
  lang = "en",
} = Astro.props;

// Helper function to get language-aware vendor description
// For EN: use description_en only
// For DE: use description_de, fallback to description_en if German is missing
function getVendorDescription(vendor: Vendor, lang: "en" | "de"): string | null {
  if (lang === "de") {
    return vendor.description_de || vendor.description_en || null;
  }
  return vendor.description_en || null;
}

// Helper function to truncate description
function truncateDescription(text: string | null | undefined, maxLength: number = 120): string {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + 'â€¦';
}

// Helper function to format technologies (first 2 only)
function formatTechnologies(technologies: string | null): string {
  if (!technologies) return '';
  const techArray = technologies.split(',').map(t => t.trim());
  return techArray.slice(0, 2).join(', ') + (techArray.length > 2 ? '...' : '');
}

// Helper function to get country flag emoji from country name/slug
function getCountryFlag(country: string | null | undefined): string {
  if (!country) return '';
  
  const countryLower = country.toLowerCase().trim();
  
  // Map common country names/slugs to flag emojis
  const countryFlags: Record<string, string> = {
    'switzerland': 'ðŸ‡¨ðŸ‡­',
    'swiss': 'ðŸ‡¨ðŸ‡­',
    'ch': 'ðŸ‡¨ðŸ‡­',
    'germany': 'ðŸ‡©ðŸ‡ª',
    'deutschland': 'ðŸ‡©ðŸ‡ª',
    'de': 'ðŸ‡©ðŸ‡ª',
    'austria': 'ðŸ‡¦ðŸ‡¹',
    'Ã¶sterreich': 'ðŸ‡¦ðŸ‡¹',
    'at': 'ðŸ‡¦ðŸ‡¹',
    'france': 'ðŸ‡«ðŸ‡·',
    'fr': 'ðŸ‡«ðŸ‡·',
    'italy': 'ðŸ‡®ðŸ‡¹',
    'italia': 'ðŸ‡®ðŸ‡¹',
    'it': 'ðŸ‡®ðŸ‡¹',
    'united states': 'ðŸ‡ºðŸ‡¸',
    'usa': 'ðŸ‡ºðŸ‡¸',
    'us': 'ðŸ‡ºðŸ‡¸',
    'united kingdom': 'ðŸ‡¬ðŸ‡§',
    'uk': 'ðŸ‡¬ðŸ‡§',
    'gb': 'ðŸ‡¬ðŸ‡§',
    'netherlands': 'ðŸ‡³ðŸ‡±',
    'nl': 'ðŸ‡³ðŸ‡±',
    'belgium': 'ðŸ‡§ðŸ‡ª',
    'be': 'ðŸ‡§ðŸ‡ª',
    'spain': 'ðŸ‡ªðŸ‡¸',
    'es': 'ðŸ‡ªðŸ‡¸',
    'portugal': 'ðŸ‡µðŸ‡¹',
    'pt': 'ðŸ‡µðŸ‡¹',
    'poland': 'ðŸ‡µðŸ‡±',
    'pl': 'ðŸ‡µðŸ‡±',
    'czech republic': 'ðŸ‡¨ðŸ‡¿',
    'czechia': 'ðŸ‡¨ðŸ‡¿',
    'cz': 'ðŸ‡¨ðŸ‡¿',
    'denmark': 'ðŸ‡©ðŸ‡°',
    'dk': 'ðŸ‡©ðŸ‡°',
    'sweden': 'ðŸ‡¸ðŸ‡ª',
    'se': 'ðŸ‡¸ðŸ‡ª',
    'norway': 'ðŸ‡³ðŸ‡´',
    'no': 'ðŸ‡³ðŸ‡´',
    'finland': 'ðŸ‡«ðŸ‡®',
    'fi': 'ðŸ‡«ðŸ‡®',
  };
  
  return countryFlags[countryLower] || '';
}

const vendorHref = `${hrefPrefix}/${vendor.slug}`;
const vendorIsFeatured = isFeatured(vendor);

// Derive category_slugs from vendor_categories if not provided
const categorySlugs = vendor.category_slugs || 
  (vendor.vendor_categories?.map((vc) => vc.categories?.slug).filter(Boolean) as string[]) || 
  [];
---

<a
  href={vendorHref}
  class="block group focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 focus-visible:ring-offset-2 rounded-lg"
  aria-label={`${vendor.name} - ${lang === "de" ? "Profil anzeigen" : "View Profile"}`}
>
  <div
    class={`relative bg-white rounded-lg border p-4 transition-all flex flex-col items-center text-center ${
      vendorIsFeatured
        ? 'bg-yellow-50/30 border-yellow-300 hover:border-yellow-400 hover:shadow-md active:bg-yellow-100/50 md:hover:bg-yellow-50/50'
        : 'border-gray-200 hover:border-gray-300 hover:shadow-md active:bg-gray-50 md:hover:bg-gray-50'
    }`}
  >
    <!-- Featured Badge -->
    {vendorIsFeatured && showFeaturedBadge && (
      <span class="absolute top-3 right-3 bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full font-medium">
        Featured
      </span>
    )}

    <!-- Vendor Logo -->
    <div class="w-[200px] h-[80px] flex items-center justify-center overflow-hidden mb-4">
      {vendor.logo_url ? (
        <img
          src={vendor.logo_url}
          alt={vendor.logo_alt || `${vendor.name} logo`}
          width={vendor.logo_width || 200}
          height={vendor.logo_height || 80}
          loading="lazy"
          class="max-w-full max-h-full object-contain"
        />
      ) : (
        <div class="w-full h-full bg-gray-100 flex items-center justify-center rounded border border-gray-200">
          <span class="text-xs text-gray-400">No Logo</span>
        </div>
      )}
    </div>

    <!-- Vendor Name -->
    <h3 class="text-lg font-semibold text-gray-900 mb-3 group-hover:text-brand-700 transition-colors">
      {vendor.name}
    </h3>

    <!-- Short Description -->
    {(() => {
      const vendorDescription = getVendorDescription(vendor, lang);
      return vendorDescription ? (
        <p class="text-sm text-gray-600 text-center mt-2">
          {truncateDescription(vendorDescription, compact ? 100 : 120)}
        </p>
      ) : null;
    })()}

    <!-- Country + Category Pills -->
    <div class="flex flex-wrap gap-2 justify-center mt-3">
      {vendor.country && (
        <span class="text-xs bg-gray-200 px-2 py-0.5 rounded">
          {getCountryFlag(vendor.country)} {vendor.country}
        </span>
      )}
      {vendor.vendor_categories && vendor.vendor_categories.length > 0 && (
        vendor.vendor_categories.map((vc) => {
          const categoryName = lang === "de" 
            ? (vc.categories?.name_de || vc.categories?.name_en)
            : (vc.categories?.name_en || vc.categories?.name_de);
          return categoryName ? (
            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">
              {categoryName}
            </span>
          ) : null;
        })
      )}
    </div>

    <!-- Technologies (first 2 only) -->
    {vendor.technologies && (
      <p class="text-xs text-gray-500 mt-2">
        {formatTechnologies(vendor.technologies)}
      </p>
    )}

    <!-- View Profile Text (styled but not a link) -->
    <span class="mt-3 inline-block text-sm text-brand-700 group-hover:text-brand-800 font-medium transition-colors">
      {lang === "de" ? "Profil anzeigen â†’" : "View Profile â†’"}
    </span>
  </div>
</a>

