---
import { isFeatured } from '../lib/isFeatured';
import type { VendorWithRelations, VendorCategoryRelation } from '../types/vendor';
import LogoBox from './LogoBox.astro';

interface VendorCardProps {
  vendor: VendorWithRelations;
  hrefPrefix?: string;
  showFeaturedBadge?: boolean;
  compact?: boolean;
  lang?: "en" | "de";
}

const {
  vendor,
  hrefPrefix = "/en/vendor",
  showFeaturedBadge = true,
  compact = false,
  lang = "en",
} = Astro.props;

// Helper function to get language-aware vendor description
// For EN: use description_en only
// For DE: use description_de, fallback to description_en if German is missing
function getVendorDescription(vendor: VendorWithRelations, lang: "en" | "de"): string | null {
  if (lang === "de") {
    return vendor.description_de || vendor.description_en || null;
  }
  return vendor.description_en || null;
}

// Helper function to truncate description
function truncateDescription(text: string | null | undefined, maxLength: number = 120): string {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + 'â€¦';
}

// Helper function to format technologies (first 2 only)
function formatTechnologies(vendor: VendorWithRelations, lang: "en" | "de"): string {
  if (!vendor.vendor_technologies || vendor.vendor_technologies.length === 0) return '';
  const techNames = vendor.vendor_technologies
    .map((vt: any) => {
      if (lang === "de") {
        return vt.technologies?.name_de || vt.technologies?.name_en;
      }
      return vt.technologies?.name_en || vt.technologies?.name_de;
    })
    .filter(Boolean)
    .slice(0, 2);
  return techNames.join(', ') + (vendor.vendor_technologies.length > 2 ? '...' : '');
}

// Helper function to get country flag emoji from country name/slug
function getCountryFlag(country: string | null | undefined): string {
  if (!country) return '';
  
  const countryLower = country.toLowerCase().trim();
  
  // Map common country names/slugs to flag emojis
  const countryFlags: Record<string, string> = {
    'switzerland': 'ğŸ‡¨ğŸ‡­',
    'swiss': 'ğŸ‡¨ğŸ‡­',
    'ch': 'ğŸ‡¨ğŸ‡­',
    'germany': 'ğŸ‡©ğŸ‡ª',
    'deutschland': 'ğŸ‡©ğŸ‡ª',
    'de': 'ğŸ‡©ğŸ‡ª',
    'austria': 'ğŸ‡¦ğŸ‡¹',
    'Ã¶sterreich': 'ğŸ‡¦ğŸ‡¹',
    'at': 'ğŸ‡¦ğŸ‡¹',
    'france': 'ğŸ‡«ğŸ‡·',
    'fr': 'ğŸ‡«ğŸ‡·',
    'italy': 'ğŸ‡®ğŸ‡¹',
    'italia': 'ğŸ‡®ğŸ‡¹',
    'it': 'ğŸ‡®ğŸ‡¹',
    'united states': 'ğŸ‡ºğŸ‡¸',
    'usa': 'ğŸ‡ºğŸ‡¸',
    'us': 'ğŸ‡ºğŸ‡¸',
    'united kingdom': 'ğŸ‡¬ğŸ‡§',
    'uk': 'ğŸ‡¬ğŸ‡§',
    'gb': 'ğŸ‡¬ğŸ‡§',
    'netherlands': 'ğŸ‡³ğŸ‡±',
    'nl': 'ğŸ‡³ğŸ‡±',
    'belgium': 'ğŸ‡§ğŸ‡ª',
    'be': 'ğŸ‡§ğŸ‡ª',
    'spain': 'ğŸ‡ªğŸ‡¸',
    'es': 'ğŸ‡ªğŸ‡¸',
    'portugal': 'ğŸ‡µğŸ‡¹',
    'pt': 'ğŸ‡µğŸ‡¹',
    'poland': 'ğŸ‡µğŸ‡±',
    'pl': 'ğŸ‡µğŸ‡±',
    'czech republic': 'ğŸ‡¨ğŸ‡¿',
    'czechia': 'ğŸ‡¨ğŸ‡¿',
    'cz': 'ğŸ‡¨ğŸ‡¿',
    'denmark': 'ğŸ‡©ğŸ‡°',
    'dk': 'ğŸ‡©ğŸ‡°',
    'sweden': 'ğŸ‡¸ğŸ‡ª',
    'se': 'ğŸ‡¸ğŸ‡ª',
    'norway': 'ğŸ‡³ğŸ‡´',
    'no': 'ğŸ‡³ğŸ‡´',
    'finland': 'ğŸ‡«ğŸ‡®',
    'fi': 'ğŸ‡«ğŸ‡®',
  };
  
  return countryFlags[countryLower] || '';
}

// Helper function to parse logo background variant from logo URL
// Supports pattern: __{variant}.{ext} (e.g., logo__dark.svg)
function parseLogoVariant(logoUrl: string | null | undefined): "light" | "dark" | "neutral" | "brand" {
  if (!logoUrl) return "light";
  
  const url = logoUrl.toLowerCase();
  
  // Check for explicit variant pattern: __{variant}.{ext}
  const explicitVariantMatch = url.match(/__([a-z]+)\.(svg|png|jpg|jpeg|webp)$/);
  if (explicitVariantMatch) {
    const variant = explicitVariantMatch[1];
    const variantMap: Record<string, "light" | "dark" | "neutral" | "brand"> = {
      white: 'light',
      light: 'neutral',
      gray: 'neutral',
      dark: 'dark',
      brand: 'brand',
    };
    if (variantMap[variant]) {
      return variantMap[variant];
    }
  }
  
  // Check for common filename patterns
  // If filename contains "white", use dark background (white logo on dark bg)
  if (url.includes('_white') || url.includes('-white') || url.match(/white[._-]/)) {
    return 'dark';
  }
  
  // If filename contains "dark" or "black", use light background
  if (url.includes('_dark') || url.includes('-dark') || url.includes('_black') || url.includes('-black')) {
    return 'light';
  }
  
  // Default to light background
  return 'light';
}

const vendorHref = `${hrefPrefix}/${vendor.slug}`;
const vendorIsFeatured = isFeatured(vendor);

// Derive category_slugs from vendor_categories if not provided
const categorySlugs = vendor.category_slugs || 
  (vendor.vendor_categories?.map((vc: VendorCategoryRelation) => vc.categories?.slug).filter(Boolean) as string[]) || 
  [];
---

<a
  href={vendorHref}
  class="block group focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 focus-visible:ring-offset-2 rounded-lg"
  aria-label={`${vendor.name} - ${lang === "de" ? "Profil anzeigen" : "View Profile"}`}
>
  <div
    class={`relative bg-white rounded-lg border p-4 transition-all flex flex-col items-center text-center ${
      vendorIsFeatured
        ? 'bg-yellow-50/30 border-yellow-300 hover:border-yellow-400 hover:shadow-md active:bg-yellow-100/50 md:hover:bg-yellow-50/50'
        : 'border-gray-200 hover:border-gray-300 hover:shadow-md active:bg-gray-50 md:hover:bg-gray-50'
    }`}
  >
    <!-- Featured Badge -->
    {vendorIsFeatured && showFeaturedBadge && (
      <span class="absolute top-3 right-3 bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full font-medium">
        Featured
      </span>
    )}

    <!-- Vendor Logo -->
    <div class="mb-4 flex justify-center">
      <LogoBox 
        src={vendor.logo_url} 
        alt={vendor.logo_alt || `${vendor.name} logo`}
        size="md"
        variant={parseLogoVariant(vendor.logo_url)}
        logoWidth={vendor.logo_width}
        logoHeight={vendor.logo_height}
      />
    </div>

    <!-- Vendor Name -->
    <h3 class="text-lg font-semibold text-gray-900 mb-3 group-hover:text-brand-700 transition-colors">
      {vendor.name}
    </h3>

    <!-- Short Description -->
    {(() => {
      const vendorDescription = getVendorDescription(vendor, lang);
      return vendorDescription ? (
        <p class="text-sm text-gray-600 text-center mt-2">
          {truncateDescription(vendorDescription, compact ? 100 : 120)}
        </p>
      ) : null;
    })()}

    <!-- Country + Category Pills -->
    <div class="flex flex-wrap gap-2 justify-center mt-3">
      {vendor.country && (
        <span class="text-xs bg-gray-200 px-2 py-0.5 rounded">
          {getCountryFlag(vendor.country)} {vendor.country}
        </span>
      )}
      {vendor.vendor_categories && vendor.vendor_categories.length > 0 && (
        vendor.vendor_categories.map((vc: VendorCategoryRelation) => {
          const categoryName = lang === "de" 
            ? (vc.categories?.name_de || vc.categories?.name_en)
            : (vc.categories?.name_en || vc.categories?.name_de);
          return categoryName ? (
            <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">
              {categoryName}
            </span>
          ) : null;
        })
      )}
    </div>

    <!-- Technologies (first 2 only) -->
    {vendor.vendor_technologies && vendor.vendor_technologies.length > 0 && (
      <p class="text-xs text-gray-500 mt-2">
        {formatTechnologies(vendor, lang)}
      </p>
    )}

    <!-- View Profile Text (styled but not a link) -->
    <span class="mt-3 inline-block text-sm text-brand-700 group-hover:text-brand-800 font-medium transition-colors">
      {lang === "de" ? "Profil anzeigen â†’" : "View Profile â†’"}
    </span>
  </div>
</a>

