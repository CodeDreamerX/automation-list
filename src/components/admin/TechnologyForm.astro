---
import { TECHNOLOGY_ICONS } from '../../lib/technologyIcons';
import { getTechnologyIconUrl } from '../../lib/iconUtils';

interface Props {
  technology: any | null;
}

const { technology } = Astro.props;
const isNewTechnology = !technology || !technology.id;

// Determine form action URL
const formAction = isNewTechnology 
  ? '/api/admin/create-technology' 
  : '/api/admin/update-technology';
---

<form method="POST" action={formAction} class="space-y-8">
  {!isNewTechnology && technology?.id && (
    <input type="hidden" name="id" value={technology.id} />
  )}

  <!-- BASIC INFORMATION -->
  <section>
    <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-1">
      Basic Information
    </h2>
    
    <div>
      <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">
        Slug *
      </label>
      <input
        type="text"
        id="slug"
        name="slug"
        value={technology?.slug || ''}
        required
        class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
      />
      <p class="text-xs text-gray-500 mt-1">URL-friendly identifier</p>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="name_en" class="block text-sm font-medium text-gray-700 mb-1">
          Name (English) *
        </label>
        <input
          type="text"
          id="name_en"
          name="name_en"
          value={technology?.name_en || ''}
          required
          class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        />
      </div>
      
      <div>
        <label for="name_de" class="block text-sm font-medium text-gray-700 mb-1">
          Name (German)
        </label>
        <input
          type="text"
          id="name_de"
          name="name_de"
          value={technology?.name_de || ''}
          class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        />
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="description_en" class="block text-sm font-medium text-gray-700 mb-1">
          Description (English)
        </label>
        <textarea
          id="description_en"
          name="description_en"
          rows="4"
          class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        >{technology?.description_en || ''}</textarea>
      </div>
      
      <div>
        <label for="description_de" class="block text-sm font-medium text-gray-700 mb-1">
          Description (German)
        </label>
        <textarea
          id="description_de"
          name="description_de"
          rows="4"
          class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        >{technology?.description_de || ''}</textarea>
      </div>
    </div>
  </section>

  <!-- ICON SELECTION -->
  <section>
    <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-1">
      Icon Selection
    </h2>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Choose an icon
      </label>
      <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3 border border-gray-300 rounded-md p-4 mb-4 icon-selection-grid">
        {TECHNOLOGY_ICONS.map((iconName) => {
          const isSelected = technology?.icon_name === iconName;
          return (
            <label 
              class={`icon-option p-3 border rounded-md cursor-pointer transition-colors ${isSelected ? "border-black bg-gray-50" : "border-gray-300 hover:border-gray-400"}`}
              data-icon-value={iconName}
            >
              <input 
                type="radio" 
                name="icon_name" 
                value={iconName} 
                checked={isSelected} 
                class="sr-only icon-radio" 
              />
              <img src={getTechnologyIconUrl(iconName)} alt={iconName.replace(/-/g, " ")} class="w-6 h-6 mx-auto" />
              <span class="text-xs text-gray-600 block text-center mt-1">{iconName.replace(/-/g, " ")}</span>
            </label>
          );
        })}
      </div>
      <p class="text-xs text-gray-500">Select an icon to represent this technology</p>
    </div>
  </section>

  <!-- SETTINGS -->
  <section>
    <h2 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-1">
      Settings
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="order_index" class="block text-sm font-medium text-gray-700 mb-1">
          Order Index
        </label>
        <input
          type="number"
          id="order_index"
          name="order_index"
          value={technology?.order_index ?? ''}
          min="0"
          step="1"
          class="border border-gray-300 rounded-md px-3 py-2 w-full text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
        />
        <p class="text-xs text-gray-500 mt-1">Lower numbers appear first (0, 1, 2, ...)</p>
      </div>
      
      <div class="flex items-center pt-6">
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            id="is_active"
            name="is_active"
            checked={technology?.is_active !== false}
            class="w-4 h-4 text-black border-gray-300 rounded focus:ring-black"
          />
          <span class="text-sm font-medium text-gray-700">Active</span>
        </label>
        <p class="text-xs text-gray-500 ml-4">Inactive technologies are hidden from public pages</p>
      </div>
    </div>
  </section>

  <!-- SUBMIT BUTTONS -->
  <div class="flex items-center justify-between pt-4 border-t">
    <a
      href="/admin/technologies"
      class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium"
    >
      Cancel
    </a>
    <button
      type="submit"
      class="px-6 py-3 bg-black text-white rounded-md hover:bg-gray-900 transition-colors font-medium"
    >
      {isNewTechnology ? 'Create Technology' : 'Save Changes'}
    </button>
  </div>
</form>

<style>
  .icon-selection-grid {
    position: relative;
  }
  
  .icon-option {
    user-select: none;
    -webkit-user-select: none;
  }
  
  .icon-option:focus-within {
    outline: none;
  }
  
  .icon-radio:focus {
    outline: none;
    box-shadow: none;
  }
  
  /* Prevent any unwanted elements from appearing at the bottom */
  form:after {
    display: none !important;
    content: none !important;
  }
  
  /* Hide any browser validation messages that might appear */
  body::after,
  html::after {
    display: none !important;
    content: none !important;
  }
</style>

<script>
  // Handle icon selection without triggering unwanted behavior
  document.addEventListener('DOMContentLoaded', function() {
    const iconOptions = document.querySelectorAll('.icon-option');
    const iconRadios = document.querySelectorAll('.icon-radio');
    const form = document.querySelector('form[method="POST"]');
    
    // Prevent form submission on icon selection
    if (form) {
      form.addEventListener('submit', function(e) {
        // Only allow submission via the submit button
        const submitButton = e.submitter;
        if (!submitButton || submitButton.type !== 'submit') {
          return;
        }
      });
    }
    
    iconOptions.forEach(function(option) {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const iconValue = option.getAttribute('data-icon-value');
        if (!iconValue) return;
        
        // Update radio button
        const radio = option.querySelector('.icon-radio');
        if (radio) {
          radio.checked = true;
          // Trigger change event manually if needed, but prevent bubbling
          const changeEvent = new Event('change', { bubbles: false, cancelable: true });
          radio.dispatchEvent(changeEvent);
        }
        
        // Update visual state
        iconOptions.forEach(function(opt) {
          const optValue = opt.getAttribute('data-icon-value');
          if (optValue === iconValue) {
            opt.classList.remove('border-gray-300', 'hover:border-gray-400');
            opt.classList.add('border-black', 'bg-gray-50');
          } else {
            opt.classList.remove('border-black', 'bg-gray-50');
            opt.classList.add('border-gray-300', 'hover:border-gray-400');
          }
        });
        
        // Prevent any default browser behavior and scrolling
        window.scrollTo(window.scrollX, window.scrollY);
        return false;
      }, { passive: false });
    });
    
    // Prevent form submission on radio button change
    iconRadios.forEach(function(radio) {
      radio.addEventListener('change', function(e) {
        e.stopPropagation();
      });
      
      radio.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    });
  });
</script>









