---
interface Props {
  vendors: any[];
  searchQuery?: string;
}

const { vendors, searchQuery = '' } = Astro.props;

// Filter vendors based on search query
let filteredVendors = vendors || [];

if (searchQuery) {
  const query = searchQuery.toLowerCase();
  filteredVendors = filteredVendors.filter((vendor) => {
    const nameMatch = vendor.name?.toLowerCase().includes(query) ?? false;
    const slugMatch = vendor.slug?.toLowerCase().includes(query) ?? false;
    // Search in vendor_technologies
    const technologiesMatch = (vendor.vendor_technologies || []).some((vt: any) => {
      const techNameEn = vt.technologies?.name_en?.toLowerCase() || '';
      const techNameDe = vt.technologies?.name_de?.toLowerCase() || '';
      return techNameEn.includes(query) || techNameDe.includes(query);
    });
    // Search in vendor_categories
    const categoryMatch = (vendor.vendor_categories || []).some((vc: any) => {
      const catNameEn = vc.categories?.name_en?.toLowerCase() || '';
      const catNameDe = vc.categories?.name_de?.toLowerCase() || '';
      return catNameEn.includes(query) || catNameDe.includes(query);
    });
    const countryMatch = vendor.country?.toLowerCase().includes(query) ?? false;
    return nameMatch || slugMatch || technologiesMatch || categoryMatch || countryMatch;
  });
}
---

<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Name
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Country
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Category
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Plan
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Featured
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Priority
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {filteredVendors.length === 0 ? (
          <tr>
            <td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">
              No vendors found.
            </td>
          </tr>
        ) : (
          filteredVendors.map((vendor) => (
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{vendor.name || '-'}</div>
                {vendor.slug && (
                  <div class="text-xs text-gray-500">{vendor.slug}</div>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">{vendor.country || '-'}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">
                  {vendor.vendor_categories && vendor.vendor_categories.length > 0 ? (
                    vendor.vendor_categories
                      .map((vc: any) => vc.categories?.name_en || vc.categories?.name_de || '')
                      .filter(Boolean)
                      .join(', ') || '-'
                  ) : '-'}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <form method="POST" action="/admin" class="inline">
                  <input type="hidden" name="action" value="change_plan" />
                  <input type="hidden" name="vendor_id" value={vendor.id} />
                  <select
                    name="plan"
                    onchange="this.form.submit()"
                    class="border border-gray-300 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-black"
                  >
                    <option value="free" selected={vendor.plan === 'free' || !vendor.plan}>Free</option>
                    <option value="pro" selected={vendor.plan === 'pro'}>Pro</option>
                    <option value="featured" selected={vendor.plan === 'featured'}>Featured</option>
                    <option value="deactivated" selected={vendor.plan === 'deactivated'}>Deactivated</option>
                  </select>
                </form>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <form method="POST" action="/admin" class="inline">
                  <input type="hidden" name="action" value="toggle_featured" />
                  <input type="hidden" name="vendor_id" value={vendor.id} />
                  <button
                    type="submit"
                    class={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                      vendor.featured
                        ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                    title={vendor.featured ? 'Click to unfeature' : 'Click to feature'}
                  >
                    {vendor.featured ? 'Featured' : 'Not Featured'}
                  </button>
                </form>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <form method="POST" action="/admin" class="inline">
                  <input type="hidden" name="action" value="change_priority" />
                  <input type="hidden" name="vendor_id" value={vendor.id} />
                  <select
                    name="priority"
                    onchange="this.form.submit()"
                    class="border border-gray-300 rounded-md px-2 py-1 text-xs w-16 focus:outline-none focus:ring-1 focus:ring-black"
                  >
                    <option value="">-</option>
                    <option value="1" selected={vendor.priority === 1}>1</option>
                    <option value="2" selected={vendor.priority === 2}>2</option>
                    <option value="3" selected={vendor.priority === 3}>3</option>
                    <option value="4" selected={vendor.priority === 4}>4</option>
                    <option value="5" selected={vendor.priority === 5}>5</option>
                  </select>
                </form>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center gap-2">
                  <a
                    href={`/admin/edit/${vendor.id}`}
                    class="text-brand-600 hover:text-brand-900"
                  >
                    Edit
                  </a>
                  <span class="text-gray-300">|</span>
                  <form method="POST" action="/admin" class="inline">
                    <input type="hidden" name="action" value="delete" />
                    <input type="hidden" name="vendor_id" value={vendor.id} />
                    <button
                      type="submit"
                      onclick={`return confirm('Are you sure you want to delete ${vendor.name}? This action cannot be undone.');`}
                      class="text-red-600 hover:text-red-900"
                    >
                      Delete
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>
</div>

