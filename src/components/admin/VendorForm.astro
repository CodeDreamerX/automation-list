---
import type { CategoryFormOption } from '../../types/category';
import type { TechnologyFormOption } from '../../types/technology';
import type { IndustryFormOption } from '../../types/industry';
import { mapDbVariantToFormVariant } from '../../lib/vendors/logoBackgroundVariant';
import BasicInfoSection from './BasicInfoSection.astro';
import ContactSection from './ContactSection.astro';
import CategorizationSection from './CategorizationSection.astro';
import CompanyInfoSection from './CompanyInfoSection.astro';
import PlanSection from './PlanSection.astro';
import LogoUploadSection from './LogoUploadSection.astro';
import SEOSection from './SEOSection.astro';

interface VendorFormProps {
  vendor: any;
  categories?: CategoryFormOption[];
  technologies?: TechnologyFormOption[];
  industries?: IndustryFormOption[];
}

const { vendor, categories = [], technologies = [], industries = [] } = Astro.props;
const isNewVendor = !vendor || !vendor.id;

// Map form variant values to LogoBox variant values
function mapVariantToLogoBox(formVariant: string): "light" | "dark" | "neutral" | "brand" {
  const mapping: Record<string, "light" | "dark" | "neutral" | "brand"> = {
    white: 'light',
    light: 'neutral', // "Light Gray" maps to neutral
    gray: 'neutral',
    dark: 'dark',
    brand: 'brand',
  };
  return mapping[formVariant] || 'light';
}

// Parse background variant from logo URL filename
// Supports pattern: __{variant}.{ext} (e.g., logo__dark.svg)
function parseBackgroundVariantFromLogoUrl(logoUrl: string | null | undefined): string {
  if (!logoUrl) return 'white';
  
  const url = logoUrl.toLowerCase();
  // Check for explicit variant pattern: __{variant}.{ext}
  const variantMatch = url.match(/__([a-z]+)\.(svg|png|jpg|jpeg|webp)$/);
  if (variantMatch) {
    const variant = variantMatch[1];
    const validVariants = ['white', 'light', 'gray', 'dark', 'brand'];
    if (validVariants.includes(variant)) {
      return variant;
    }
  }
  
  // Default to white if no variant found
  return 'white';
}

// Use stored logo_background_variant if available (mapped from DB to form value), otherwise parse from logo URL, default to 'white'
const storedDbVariant = vendor?.logo_background_variant;
const defaultBackgroundVariant: string = storedDbVariant 
  ? mapDbVariantToFormVariant(storedDbVariant)
  : (parseBackgroundVariantFromLogoUrl(vendor?.logo_url) || 'white');
const defaultLogoBoxVariant = mapVariantToLogoBox(defaultBackgroundVariant);
---

<form id="vendor-form" method="POST" class="space-y-8">
  {!isNewVendor && vendor?.id && (
    <input type="hidden" name="id" value={vendor.id} />
  )}
  
  <BasicInfoSection vendor={vendor} />
  <ContactSection vendor={vendor} />
  <CategorizationSection 
    vendor={vendor} 
    categories={categories}
    technologies={technologies}
    industries={industries}
  />
  <CompanyInfoSection vendor={vendor} />
  <PlanSection vendor={vendor} />
  <LogoUploadSection 
    vendor={vendor}
    defaultBackgroundVariant={defaultBackgroundVariant}
    defaultLogoBoxVariant={defaultLogoBoxVariant}
  />
  <SEOSection vendor={vendor} />

  <!-- SUBMIT BUTTONS -->
  <div class="flex items-center justify-between pt-4 border-t">
    <a
      href="/admin"
      class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium"
    >
      Cancel
    </a>
    <button
      type="submit"
      class="px-6 py-3 bg-black text-white rounded-md hover:bg-gray-900 transition-colors font-medium"
    >
      {isNewVendor ? 'Create Vendor' : 'Save Changes'}
    </button>
  </div>
</form>

<script>
  import { initVendorForm } from './vendor-form';
  initVendorForm();
</script>
