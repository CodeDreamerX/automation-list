---
import { allowedFields, REQUIRED_FIELDS, type ValidationResult } from '../../lib/admin/csvUtils';

interface Props {
  normalizedData: any[];
  validationResults: ValidationResult[];
  rowCount: number;
}

const { normalizedData, validationResults, rowCount } = Astro.props;

// Define display fields in a logical order
const displayFields = [
  'name',
  'slug',
  'country',
  'region',
  'city',
  'address',
  'website',
  'email',
  'phone',
  'description',
  'category_slugs', // Will be displayed as _categorySlugs
  'technology_slugs', // Will be displayed as _technologySlugs
  'industries',
  'technologies',
  'languages',
  'certifications',
  'tags',
  'year_founded',
  'employee_count',
  'hourly_rate',
  'plan',
  'featured',
  'priority',
  'og_member',
];
---

<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">
    Preview (First 10 Rows)
  </h2>
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-300">
      <thead class="bg-gray-100">
        <tr>
          {displayFields.map((key) => (
            <th class="px-3 py-2 text-left text-xs font-bold text-gray-900 uppercase tracking-wider border-b border-gray-300 max-w-xs">
              <div class="truncate" title={key}>
                {key === 'category_slugs' ? 'categories' : key === 'technology_slugs' ? 'technologies' : key}
                {REQUIRED_FIELDS.includes(key) && (
                  <span class="text-red-600 ml-1">*</span>
                )}
              </div>
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {normalizedData.slice(0, 10).map((row, idx) => {
          const validation = validationResults[idx];
          const hasErrors = validation.missingRequired.length > 0;
          const hasWarnings = validation.invalidEmail || validation.invalidWebsite || validation.duplicateSlug;
          
          // Determine row background color with alternating pattern
          let rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          if (hasErrors) {
            rowClass = idx % 2 === 0 ? 'bg-red-50' : 'bg-red-100';
          } else if (hasWarnings) {
            rowClass = idx % 2 === 0 ? 'bg-yellow-50' : 'bg-yellow-100';
          }
          
          return (
            <tr class={`${rowClass} border-b border-gray-200`}>
              {displayFields.map((field) => {
                // Handle category_slugs and technology_slugs specially - use arrays
                let value;
                if (field === 'category_slugs') {
                  value = row._categorySlugs && row._categorySlugs.length > 0 
                    ? row._categorySlugs.join(", ") 
                    : null;
                } else if (field === 'technology_slugs') {
                  value = row._technologySlugs && row._technologySlugs.length > 0 
                    ? row._technologySlugs.join(", ") 
                    : null;
                } else {
                  value = row[field];
                }
                
                const isRequired = REQUIRED_FIELDS.includes(field);
                const isMissing = isRequired && (!value || value === null);
                
                // Determine cell background color
                let cellClass = 'px-3 py-2 text-xs text-gray-900 text-left';
                if (isMissing) {
                  cellClass += ' bg-red-200';
                } else if (field === 'email' && validation.invalidEmail) {
                  cellClass += ' bg-yellow-200';
                } else if (field === 'website' && validation.invalidWebsite) {
                  cellClass += ' bg-yellow-200';
                } else if (field === 'slug' && validation.duplicateSlug) {
                  cellClass += ' bg-yellow-200';
                }
                
                // Limit width for long text columns
                let maxWidthClass = 'max-w-xs';
                if (field === 'description') {
                  maxWidthClass = 'max-w-md';
                } else if (field === 'name' || field === 'address') {
                  maxWidthClass = 'max-w-sm';
                } else if (field === 'category_slugs' || field === 'technology_slugs' || field === 'technologies' || field === 'tags') {
                  maxWidthClass = 'max-w-xs';
                } else if (['email', 'website', 'phone'].includes(field)) {
                  maxWidthClass = 'max-w-xs';
                } else {
                  maxWidthClass = 'max-w-32';
                }
                
                // Format boolean values
                let displayValue = value;
                if (field === 'featured' || field === 'og_member') {
                  displayValue = value === true || value === 'true' || value === '1' || value === 'yes' ? 'Yes' : 'No';
                }
                
                return (
                  <td class={`${cellClass} ${maxWidthClass}`}>
                    <div class="truncate" title={typeof displayValue === 'string' ? displayValue : displayValue?.toString()}>
                      {displayValue !== null && displayValue !== undefined 
                        ? displayValue.toString() 
                        : <span class="text-gray-400 italic">(empty)</span>}
                    </div>
                  </td>
                );
              })}
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
  
  {rowCount > 10 && (
    <p class="mt-4 text-sm text-gray-600">
      Showing first 10 of {rowCount} rows
    </p>
  )}
</div>


