---
import LogoBox from './LogoBox.astro';

interface Vendor {
  name: string;
  slug: string;
  country?: string | null;
  technologies?: string | null;
  description_en?: string | null;
  description_de?: string | null;
  logo_url?: string | null;
  logo_width?: number | null;
  logo_height?: number | null;
  logo_alt?: string | null;
  priority?: number | null;
  vendor_categories?: Array<{
    is_primary?: boolean;
    categories?: {
      id: string;
      slug: string;
      name_en?: string;
      name_de?: string;
    };
  }>;
}

interface Props {
  title?: string;
  vendors: Vendor[];
  viewAllHref: string;
  viewAllText?: string;
  vendorHrefPrefix: string;
  vendorLinkText?: string;
  formatTechnologies?: (tech: string | null) => string;
  truncateDescription?: (text: string | null | undefined, maxLength?: number) => string;
  isFeatured?: (vendor: Vendor) => boolean;
}

const {
  title = "Featured Vendors",
  vendors,
  viewAllHref,
  viewAllText = "View All Vendors →",
  vendorHrefPrefix,
  vendorLinkText = "View Profile →",
  formatTechnologies = (tech: string | null) => {
    if (!tech) return '';
    const techArray = tech.split(',').map(t => t.trim());
    return techArray.slice(0, 2).join(', ') + (techArray.length > 2 ? '...' : '');
  },
  truncateDescription = (text: string | null | undefined, maxLength: number = 120) => {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '…';
  },
  isFeatured = () => false,
} = Astro.props;

// Infer language from vendorHrefPrefix (/en/vendor = "en", /de/vendor = "de")
const lang: "en" | "de" = vendorHrefPrefix.startsWith("/de/") ? "de" : "en";

// Helper function to get language-aware vendor description
// For EN: use description_en
// For DE: use description_de, fallback to description_en if missing
function getVendorDescription(vendor: Vendor): string | null {
  if (lang === "de") {
    return vendor.description_de || vendor.description_en || null;
  }
  return vendor.description_en || null;
}
---

<section class="fade-in-up container-px mx-auto max-w-7xl px-4 py-16 md:py-20">
  <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 md:mb-10 text-center">{title}</h2>
  {vendors.length > 0 ? (
    <>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {vendors.map((vendor, i) => {
          const vendorIsFeatured = isFeatured(vendor);
          const vendorHref = `${vendorHrefPrefix}/${vendor.slug}`;
          return (
            <a
              href={vendorHref}
              class="block group focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 focus-visible:ring-offset-2 rounded-lg fade-in-up"
              style={`animation-delay: ${i * 0.07}s`}
              aria-label={`${vendor.name} - ${vendorLinkText}`}
            >
              <div
                class={`border rounded-lg p-6 shadow-sm transition-all ${
                  vendorIsFeatured 
                    ? 'border-yellow-300 bg-yellow-50/30 shadow-lg hover:border-yellow-400 hover:shadow-md active:bg-yellow-100/50 md:hover:bg-yellow-50/50' 
                    : 'border-gray-200 hover:border-gray-300 hover:shadow-md active:bg-gray-50 md:hover:bg-gray-50'
                }`}
              >
                {vendorIsFeatured && (
                  <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full mb-3">
                    Featured Vendor
                  </span>
                )}
                
                <div class="mb-4 mx-auto">
                  <LogoBox
                    src={vendor.logo_url}
                    alt={vendor.logo_alt || `${vendor.name} automation logo`}
                  />
                </div>
                
                <h3 class="text-lg font-semibold text-gray-900 mb-1 group-hover:text-brand-700 transition-colors">
                  {vendor.name}
                </h3>
                
                {vendor.country && (
                  <p class="text-sm text-gray-600 mb-2">{vendor.country}</p>
                )}
                
                {/* Display primary category from vendor_categories */}
                {vendor.vendor_categories && vendor.vendor_categories.length > 0 && (
                  vendor.vendor_categories
                    .filter((vc: any) => vc.is_primary === true)
                    .map((vc: any) => {
                      const categoryName = vc.categories?.name_en || vc.categories?.name_de;
                      return categoryName ? (
                        <span class="inline-block mb-2 px-2 py-1 text-xs font-medium bg-brand-50 text-brand-700 rounded">
                          {categoryName}
                        </span>
                      ) : null;
                    })
                )}
                
                {vendor.technologies && (
                  <p class="text-xs text-gray-500 mb-3">{formatTechnologies(vendor.technologies)}</p>
                )}
                
                {(() => {
                  const vendorDescription = getVendorDescription(vendor);
                  return vendorDescription ? (
                    <p class="text-sm text-gray-600 mb-4">{truncateDescription(vendorDescription, 120)}</p>
                  ) : null;
                })()}
                
                <span class="inline-block text-sm text-brand-700 group-hover:text-brand-800 font-medium transition-colors">
                  {vendorLinkText}
                </span>
              </div>
            </a>
          );
        })}
      </div>
      <div class="text-center mt-10">
        <a href={viewAllHref} class="text-brand-700 font-medium hover:underline">{viewAllText}</a>
      </div>
    </>
  ) : (
    <p class="text-center text-gray-600">No featured vendors available at the moment.</p>
  )}
</section>

